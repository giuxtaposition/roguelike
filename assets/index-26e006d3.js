var ue=Object.defineProperty;var he=(t,e,s)=>e in t?ue(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var a=(t,e,s)=>(he(t,typeof e!="symbol"?e+"":e,s),s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&i(l)}).observe(document,{childList:!0,subtree:!0});function s(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerpolicy&&(r.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?r.credentials="include":n.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=s(n);fetch(n.href,r)}})();function _(){}function q(t){return t()}function X(){return Object.create(null)}function I(t){t.forEach(q)}function J(t){return typeof t=="function"}function Q(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function ce(t){return Object.keys(t).length===0}function V(t,e,s){t.insertBefore(e,s||null)}function z(t){t.parentNode&&t.parentNode.removeChild(t)}function Z(t){return document.createElement(t)}function fe(t,e,s,i){return t.addEventListener(e,s,i),()=>t.removeEventListener(e,s,i)}function de(t){return function(e){return e.preventDefault(),t.call(this,e)}}function ge(t,e,s){s==null?t.removeAttribute(e):t.getAttribute(e)!==s&&t.setAttribute(e,s)}function me(t){return Array.from(t.childNodes)}let C;function $(t){C=t}function pe(){if(!C)throw new Error("Function called outside component initialization");return C}function ye(t){pe().$$.on_mount.push(t)}const b=[],G=[],M=[],Y=[],Te=Promise.resolve();let B=!1;function ve(){B||(B=!0,Te.then(ee))}function j(t){M.push(t)}const H=new Set;let E=0;function ee(){if(E!==0)return;const t=C;do{try{for(;E<b.length;){const e=b[E];E++,$(e),we(e.$$)}}catch(e){throw b.length=0,E=0,e}for($(null),b.length=0,E=0;G.length;)G.pop()();for(let e=0;e<M.length;e+=1){const s=M[e];H.has(s)||(H.add(s),s())}M.length=0}while(b.length);for(;Y.length;)Y.pop()();B=!1,H.clear(),$(t)}function we(t){if(t.fragment!==null){t.update(),I(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(j)}}const A=new Set;let _e;function te(t,e){t&&t.i&&(A.delete(t),t.i(e))}function xe(t,e,s,i){if(t&&t.o){if(A.has(t))return;A.add(t),_e.c.push(()=>{A.delete(t),i&&(s&&t.d(1),i())}),t.o(e)}else i&&i()}function Ee(t){t&&t.c()}function se(t,e,s,i){const{fragment:n,after_update:r}=t.$$;n&&n.m(e,s),i||j(()=>{const l=t.$$.on_mount.map(q).filter(J);t.$$.on_destroy?t.$$.on_destroy.push(...l):I(l),t.$$.on_mount=[]}),r.forEach(j)}function ie(t,e){const s=t.$$;s.fragment!==null&&(I(s.on_destroy),s.fragment&&s.fragment.d(e),s.on_destroy=s.fragment=null,s.ctx=[])}function be(t,e){t.$$.dirty[0]===-1&&(b.push(t),ve(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function ne(t,e,s,i,n,r,l,w=[-1]){const g=C;$(t);const h=t.$$={fragment:null,ctx:[],props:r,update:_,not_equal:n,bound:X(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(g?g.$$.context:[])),callbacks:X(),dirty:w,skip_bound:!1,root:e.target||g.$$.root};l&&l(h.root);let x=!1;if(h.ctx=s?s(t,e.props||{},(p,L,...v)=>{const P=v.length?v[0]:L;return h.ctx&&n(h.ctx[p],h.ctx[p]=P)&&(!h.skip_bound&&h.bound[p]&&h.bound[p](P),x&&be(t,p)),L}):[],h.update(),x=!0,I(h.before_update),h.fragment=i?i(h.ctx):!1,e.target){if(e.hydrate){const p=me(e.target);h.fragment&&h.fragment.l(p),p.forEach(z)}else h.fragment&&h.fragment.c();e.intro&&te(t.$$.fragment),se(t,e.target,e.anchor,e.customElement),ee()}$(g)}class re{$destroy(){ie(this,1),this.$destroy=_}$on(e,s){if(!J(s))return _;const i=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return i.push(s),()=>{const n=i.indexOf(s);n!==-1&&i.splice(n,1)}}$set(e){this.$$set&&!ce(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}function D(t,e){for(let s=1e3;s>0;s--)if(e())return;throw"Timeout while trying to "+t}function N(t,e){return Math.floor(Math.random()*(e-t+1))+t}function le(t){let e,s;for(let i=1;i<t.length;i++)s=N(0,i),e=t[i],t[i]=t[s],t[s]=e;return t}const F=class{constructor(e,s,i){a(this,"tile");a(this,"sprite");a(this,"health");a(this,"isPlayer",!1);a(this,"isAlive",!0);a(this,"hasAttackedThisTurn",!1);a(this,"isStunned",!1);a(this,"teleportCounter",2);this.move(e),this.sprite=s,this.health=i}update(e,s,i){if(this.teleportCounter--,!(this.teleportCounter>0)){if(this.isStunned){this.isStunned=!1;return}this.doEntityBehavior(e,s,i)}}tryToMove(e){if(e.getIsPassable())return e.getEntity()?e.getEntity().getIsPlayer()!==this.isPlayer&&(this.hasAttackedThisTurn=!0,e.getEntity().isStunned=!0,e.getEntity().receiveDamage(1)):this.move(e),!0}receiveDamage(e){this.health-=e,this.health<=0&&this.die()}getTeleportCounter(){return this.teleportCounter}getIsStunned(){return this.isStunned}getTile(){return this.tile}getIsAlive(){return this.isAlive}getIsPlayer(){return this.isPlayer}getHealth(){return this.health}getSprite(){return this.sprite}move(e){this.tile&&this.tile.setEntity(null),this.tile=e,e.setEntity(this)}doEntityBehavior(e,s,i){const n=e.filter(r=>r.getIsPassable()&&(!r.getEntity()||r.getEntity().getIsPlayer()));if(n.length){n.sort((h,x)=>h.distance(s.tile)-x.distance(s.tile));const{x:r,y:l}=n[0].getCoordinates(),{x:w,y:g}=this.tile.getCoordinates();this.tryToMove(i(this.getTile(),r-w,l-g))}}receiveHealth(e){this.health=Math.min(F.maxHealth,this.health+e)}die(){this.isAlive=!1,this.tile.setEntity(null),this.sprite=1}};let T=F;a(T,"maxHealth",6);class Pe extends T{constructor(e){super(e,4,3)}}class Se extends T{constructor(e){super(e,5,1)}doEntityBehavior(e,s,i){this.hasAttackedThisTurn=!1,super.doEntityBehavior(e,s,i),this.hasAttackedThisTurn||super.doEntityBehavior(e,s,i)}}class $e extends T{constructor(e){super(e,6,2)}doEntityBehavior(e,s,i){let n=e.filter(r=>r.getIsPassable()&&(!r.getEntity()||r.getEntity().getIsPlayer()));if(n.length){const{x:r,y:l}=n[0].getCoordinates(),{x:w,y:g}=this.tile.getCoordinates();this.tryToMove(i(this.getTile(),r-w,l-g))}}}class Ce extends T{constructor(e){super(e,7,1)}doEntityBehavior(e,s,i){const n=e.filter(r=>!r.getIsPassable()&&u.inBounds(r.getCoordinates().x,r.getCoordinates().y));n.length?(n[0].replace(ae),this.receiveHealth(.5)):super.doEntityBehavior(e,s,i)}}class Le extends T{constructor(e){super(e,8,3)}update(e,s,i){let n=this.isStunned;super.update(e,s,i),n||(this.isStunned=!0)}}class Me extends T{constructor(e,s){super(e,0,s),this.isPlayer=!0}}class Ae{constructor(){a(this,"startingHealth",3);a(this,"maxHealth",10);a(this,"maxLevel",6);a(this,"level");a(this,"map");a(this,"enemies",[]);a(this,"player");a(this,"spawnRate");a(this,"spawnCounter");a(this,"gameState",m.Loading)}start(){this.level=1,this.startLevel(this.startingHealth),this.gameState=m.Running}movePlayer(e){let s=!1;switch(e){case y.UP:s=this.tryToMovePlayer(0,-1);break;case y.DOWN:s=this.tryToMovePlayer(0,1);break;case y.LEFT:s=this.tryToMovePlayer(-1,0);break;case y.RIGHT:s=this.tryToMovePlayer(1,0);break}s&&this.tick()}getGameState(){return this.gameState}setGameState(e){this.gameState=e}getPlayer(){return this.player}getMap(){return this.map}getEnemies(){return this.enemies}getMaxHealth(){return this.maxHealth}getLevel(){return this.level}updateLevel(){this.level+=1}getMaxLevel(){return this.maxLevel}startLevel(e){this.enemies=[],this.spawnRate=15,this.spawnCounter=this.spawnRate,this.generateLevel(),this.player=new Me(this.map.getRandomPassableTile(),e),this.map.getRandomPassableTile().replace(K)}playerSteppedOnExitTile(){this.level==this.maxLevel?this.setGameState(m.GameOver):(this.level+=1,this.startLevel(Math.min(this.maxHealth,this.player.getHealth()+1)))}tick(){for(let e=this.enemies.length-1;e>=0;e--){const s=this.enemies[e];s.getIsAlive()?s.update(this.map.getAdjacentTiles(s.getTile()),this.player,this.map.getTileAtDistanceXY.bind(this.map)):this.removeEnemy(e)}this.player.getIsAlive()||(this.gameState=m.GameOver),this.spawnCounter--,this.spawnCounter<=0&&(this.spawnEnemies(),this.spawnCounter=this.spawnRate,this.spawnRate--)}tryToMovePlayer(e,s){const i=this.map.getTileAtDistanceXY(this.player.getTile(),e,s);return i instanceof K&&!i.getEntity()&&this.playerSteppedOnExitTile(),this.player.tryToMove(i)}removeEnemy(e){this.enemies.splice(e,1)}generateLevel(){this.map=new u,this.generateEnemies()}generateEnemies(){let e=this.level+1;for(let s=0;s<e;s++)this.spawnEnemies()}spawnEnemies(){let e=le([Pe,Se,$e,Ce,Le])[0];this.enemies.push(new e(this.map.getRandomPassableTile()))}}var y=(t=>(t[t.UP=0]="UP",t[t.DOWN=1]="DOWN",t[t.LEFT=2]="LEFT",t[t.RIGHT=3]="RIGHT",t))(y||{}),m=(t=>(t.Title="title",t.GameOver="gameOver",t.Running="running",t.Loading="loading",t))(m||{});class W{constructor(e,s,i,n,r){a(this,"x");a(this,"y");a(this,"sprite");a(this,"isPassable");a(this,"entity");a(this,"map");this.x=e,this.y=s,this.sprite=i,this.isPassable=n,this.map=r}distance(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}replace(e){this.map.getTiles()[this.x][this.y]=new e(this.x,this.y,this.map)}getEntity(){return this.entity}setEntity(e){this.entity=e}getCoordinates(){return{x:this.x,y:this.y}}getIsPassable(){return this.isPassable}getSprite(){return this.sprite}}class ae extends W{constructor(e,s,i){super(e,s,2,!0,i)}}class U extends W{constructor(e,s,i){super(e,s,3,!1,i)}}class K extends W{constructor(e,s,i){super(e,s,11,!0,i)}}var S;let u=(S=class{constructor(){a(this,"tiles",[]);D("generate map",()=>this.generateTiles()==this.getConnectedTiles(this.getRandomPassableTile()).length)}getTileAtDistanceXY(e,s,i){const{x:n,y:r}=e.getCoordinates();return this.getTile(n+s,r+i)}getAdjacentPassableTiles(e){return this.getAdjacentTiles(e).filter(s=>s.getIsPassable())}getRandomPassableTile(){let e;return D("get random passable tile",()=>{let s=N(0,u.numTiles-1),i=N(0,u.numTiles-1);return e=this.getTile(s,i),e.getIsPassable()}),e}getTile(e,s){return u.inBounds(e,s)?this.tiles[e][s]:new U(e,s,this)}getAdjacentTiles(e){const{x:s,y:i}=e.getCoordinates();return le([this.getTile(s,i-1),this.getTile(s,i+1),this.getTile(s-1,i),this.getTile(s+1,i)])}getTiles(){return this.tiles}static inBounds(e,s){return e>0&&s>0&&e<u.numTiles-1&&s<u.numTiles-1}generateTiles(){let e=0;for(let s=0;s<u.numTiles;s++){this.tiles[s]=[];for(let i=0;i<u.numTiles;i++)Math.random()<.3||!u.inBounds(s,i)?this.tiles[s][i]=new U(s,i,this):(this.tiles[s][i]=new ae(s,i,this),e++)}return e}getConnectedTiles(e){let s=[e],i=[e];for(;i.length;){let n=i.pop(),r=this.getAdjacentPassableTiles(n).filter(l=>!s.includes(l));s=s.concat(r),i=i.concat(r)}return s}},a(S,"tileSize",64),a(S,"numTiles",9),a(S,"uiWidth",4),S);function Ie(t){let e,s,i;return{c(){e=Z("canvas"),ge(e,"class","svelte-7suhn9")},m(n,r){V(n,e,r),t[2](e),s||(i=fe(window,"keydown",de(t[1])),s=!0)},p:_,i:_,o:_,d(n){n&&z(e),t[2](null),s=!1,i()}}}function ke(t,e,s){let i,n;const r=new Image;r.src="spritesheet.png",r.onload=g;const l=new Ae;function w(o){switch(l.getGameState()){case m.Title:l.start();break;case m.GameOver:g();break;case m.Running:o.key=="w"&&l.movePlayer(y.UP),o.key=="s"&&l.movePlayer(y.DOWN),o.key=="a"&&l.movePlayer(y.LEFT),o.key=="d"&&l.movePlayer(y.RIGHT);break}}function g(){n.fillStyle="rgba(0,0,0,.75)",n.fillRect(0,0,i.width,i.height),l.setGameState(m.Title),k("a simple",40,!0,i.height/2-100,"white"),k("ROGUELIKE",70,!0,i.height/2-30,"white")}function h(){(l.getGameState()===m.Running||l.getGameState()===m.GameOver)&&(n.clearRect(0,0,i.width,i.height),L(),p(),x(),k("Level: "+l.getLevel(),30,!1,40,"#bd516d"))}function x(){for(let o=0;o<l.getEnemies().length;o++){const c=l.getEnemies()[o],{x:f,y:d}=c.getTile().getCoordinates();c.getTeleportCounter()>0?v(10,f,d):(v(c.getSprite(),f,d),P(c,f,d))}}function p(){const{x:o,y:c}=l.getPlayer().getTile().getCoordinates();v(l.getPlayer().getSprite(),o,c),P(l.getPlayer(),o,c)}function L(){for(let o=0;o<u.numTiles;o++)for(let c=0;c<u.numTiles;c++){const f=l.getMap().getTile(o,c),{x:d,y:O}=f.getCoordinates();v(f.getSprite(),d,O)}}function v(o,c,f){n.drawImage(r,o*16,0,16,16,c*u.tileSize,f*u.tileSize,u.tileSize,u.tileSize)}function P(o,c,f){for(let d=0;d<o.getHealth();d++)v(9,c+d%3*(4/16),f-Math.floor(d/3)*(5/16))}function k(o,c,f,d,O){n.fillStyle=O,n.font=c+"px monospace";let R;f?R=(i.width-n.measureText(o).width)/2:R=u.tileSize*u.numTiles+25,n.fillText(o,R,d)}ye(()=>{n=i.getContext("2d"),s(0,i.width=u.tileSize*(u.numTiles+u.uiWidth),i),s(0,i.height=u.tileSize*u.numTiles,i),s(0,i.style.width=i.width+"px",i),s(0,i.style.height=i.height+"px",i),n.imageSmoothingEnabled=!1});function oe(o){G[o?"unshift":"push"](()=>{i=o,s(0,i)})}return setInterval(h,15),[i,w,oe]}class Oe extends re{constructor(e){super(),ne(this,e,ke,Ie,Q,{})}}function Re(t){let e,s,i;return s=new Oe({}),{c(){e=Z("main"),Ee(s.$$.fragment)},m(n,r){V(n,e,r),se(s,e,null),i=!0},p:_,i(n){i||(te(s.$$.fragment,n),i=!0)},o(n){xe(s.$$.fragment,n),i=!1},d(n){n&&z(e),ie(s)}}}class He extends re{constructor(e){super(),ne(this,e,null,Re,Q,{})}}new He({target:document.body});
