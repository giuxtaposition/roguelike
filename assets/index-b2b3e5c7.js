var be=Object.defineProperty;var Se=(s,e,t)=>e in s?be(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var l=(s,e,t)=>(Se(s,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const h of r.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&i(h)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerpolicy&&(r.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?r.credentials="include":n.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();function g(){}function ne(s){return s()}function Q(){return Object.create(null)}function X(s){s.forEach(ne)}function re(s){return typeof s=="function"}function G(s,e){return s!=s?e==e:s!==e||s&&typeof s=="object"||typeof s=="function"}function we(s){return Object.keys(s).length===0}function le(s,...e){if(s==null)return g;const t=s.subscribe(...e);return t.unsubscribe?()=>t.unsubscribe():t}function ae(s){let e;return le(s,t=>e=t)(),e}function xe(s,e,t){s.$$.on_destroy.push(le(e,t))}function oe(s,e,t){s.insertBefore(e,t||null)}function W(s){s.parentNode&&s.parentNode.removeChild(s)}function ue(s){return document.createElement(s)}function Pe(s,e,t,i){return s.addEventListener(e,t,i),()=>s.removeEventListener(e,t,i)}function Ae(s){return function(e){return e.preventDefault(),s.call(this,e)}}function ce(s,e,t){t==null?s.removeAttribute(e):s.getAttribute(e)!==t&&s.setAttribute(e,t)}function Ee(s){return Array.from(s.childNodes)}let C;function $(s){C=s}function Oe(){if(!C)throw new Error("Function called outside component initialization");return C}function $e(s){Oe().$$.on_mount.push(s)}const E=[],I=[],N=[],V=[],Ce=Promise.resolve();let B=!1;function Re(){B||(B=!0,Ce.then(he))}function F(s){N.push(s)}const j=new Set;let P=0;function he(){if(P!==0)return;const s=C;do{try{for(;P<E.length;){const e=E[P];P++,$(e),Le(e.$$)}}catch(e){throw E.length=0,P=0,e}for($(null),E.length=0,P=0;I.length;)I.pop()();for(let e=0;e<N.length;e+=1){const t=N[e];j.has(t)||(j.add(t),t())}N.length=0}while(E.length);for(;V.length;)V.pop()();B=!1,j.clear(),$(s)}function Le(s){if(s.fragment!==null){s.update(),X(s.before_update);const e=s.dirty;s.dirty=[-1],s.fragment&&s.fragment.p(s.ctx,e),s.after_update.forEach(F)}}const k=new Set;let Me;function fe(s,e){s&&s.i&&(k.delete(s),s.i(e))}function Ne(s,e,t,i){if(s&&s.o){if(k.has(s))return;k.add(s),Me.c.push(()=>{k.delete(s),i&&(t&&s.d(1),i())}),s.o(e)}else i&&i()}function ke(s){s&&s.c()}function _e(s,e,t,i){const{fragment:n,after_update:r}=s.$$;n&&n.m(e,t),i||F(()=>{const h=s.$$.on_mount.map(ne).filter(re);s.$$.on_destroy?s.$$.on_destroy.push(...h):X(h),s.$$.on_mount=[]}),r.forEach(F)}function pe(s,e){const t=s.$$;t.fragment!==null&&(X(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function He(s,e){s.$$.dirty[0]===-1&&(E.push(s),Re(),s.$$.dirty.fill(0)),s.$$.dirty[e/31|0]|=1<<e%31}function de(s,e,t,i,n,r,h,u=[-1]){const d=C;$(s);const o=s.$$={fragment:null,ctx:[],props:r,update:g,not_equal:n,bound:Q(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(d?d.$$.context:[])),callbacks:Q(),dirty:u,skip_bound:!1,root:e.target||d.$$.root};h&&h(o.root);let x=!1;if(o.ctx=t?t(s,e.props||{},(y,L,...M)=>{const T=M.length?M[0]:L;return o.ctx&&n(o.ctx[y],o.ctx[y]=T)&&(!o.skip_bound&&o.bound[y]&&o.bound[y](T),x&&He(s,y)),L}):[],o.update(),x=!0,X(o.before_update),o.fragment=i?i(o.ctx):!1,e.target){if(e.hydrate){const y=Ee(e.target);o.fragment&&o.fragment.l(y),y.forEach(W)}else o.fragment&&o.fragment.c();e.intro&&fe(s.$$.fragment),_e(s,e.target,e.anchor,e.customElement),he()}$(d)}class me{$destroy(){pe(this,1),this.$destroy=g}$on(e,t){if(!re(t))return g;const i=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return i.push(t),()=>{const n=i.indexOf(t);n!==-1&&i.splice(n,1)}}$set(e){this.$$set&&!we(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}function Z(s,e){for(let t=1e3;t>0;t--)if(e())return;throw"Timeout while trying to "+s}function z(s,e){return Math.floor(Math.random()*(e-s+1))+s}function H(s){let e,t;for(let i=1;i<s.length;i++)t=z(0,i),e=s[i],s[i]=s[t],s[t]=e;return s}class U{constructor(e,t,i,n,r){l(this,"_x");l(this,"_y");l(this,"_sprite");l(this,"_effect");l(this,"_effectCounter");l(this,"_entity");l(this,"_map");l(this,"_hasTreasure",!1);l(this,"_isPassable");this._x=e,this._y=t,this._sprite=i,this._isPassable=n,this._map=r}distance(e){return Math.abs(this._x-e._x)+Math.abs(this._y-e._y)}replace(e){this._map.tiles[this._x][this._y]=new e(this._x,this._y,this._map)}get effect(){return this._effect}set effect(e){this._effect=e,this._effectCounter=35}get effectCounter(){return this._effectCounter}set effectCounter(e){this._effectCounter=e}get hasTreasure(){return this._hasTreasure}set hasTreasure(e){this._hasTreasure=e}get entity(){return this._entity}set entity(e){this._entity=e}get coordinates(){return{x:this._x,y:this._y}}get isPassable(){return this._isPassable}get sprite(){return this._sprite}}class ge extends U{constructor(e,t,i){super(e,t,2,!0,i)}}class ee extends U{constructor(e,t,i){super(e,t,3,!1,i)}}class te extends U{constructor(e,t,i){super(e,t,11,!0,i)}}var O;let _=(O=class{constructor(){l(this,"_tiles",[]);Z("generate map",()=>this.generateTiles()==this.getConnectedTiles(this.getRandomPassableTile()).length)}getTileAtDistanceXY(e,t,i){const{x:n,y:r}=e.coordinates;return this.getTile(n+t,r+i)}getAdjacentPassableTiles(e){return this.getAdjacentTiles(e).filter(t=>t.isPassable)}getRandomPassableTile(){let e;return Z("get random passable tile",()=>{let t=z(0,_.numTiles-1),i=z(0,_.numTiles-1);return e=this.getTile(t,i),e.isPassable&&!e.entity}),e}getTile(e,t){return _.inBounds(e,t)?this._tiles[e][t]:new ee(e,t,this)}getAdjacentTiles(e){const{x:t,y:i}=e.coordinates;return H([this.getTile(t,i-1),this.getTile(t,i+1),this.getTile(t-1,i),this.getTile(t+1,i)])}get tiles(){return this._tiles}static inBounds(e,t){return e>0&&t>0&&e<_.numTiles-1&&t<_.numTiles-1}generateTiles(){let e=0;for(let t=0;t<_.numTiles;t++){this._tiles[t]=[];for(let i=0;i<_.numTiles;i++)Math.random()<.3||!_.inBounds(t,i)?this._tiles[t][i]=new ee(t,i,this):(this._tiles[t][i]=new ge(t,i,this),e++)}return e}getConnectedTiles(e){let t=[e],i=[e];for(;i.length;){let n=i.pop(),r=this.getAdjacentPassableTiles(n).filter(h=>!t.includes(h));t=t.concat(r),i=i.concat(r)}return t}},l(O,"tileSize",64),l(O,"numTiles",12),l(O,"uiWidth",4),O);const A=[];function ye(s,e=g){let t;const i=new Set;function n(u){if(G(s,u)&&(s=u,t)){const d=!A.length;for(const o of i)o[1](),A.push(o,s);if(d){for(let o=0;o<A.length;o+=2)A[o][0](A[o+1]);A.length=0}}}function r(u){n(u(s))}function h(u,d=g){const o=[u,d];return i.add(o),i.size===1&&(t=e(n)||g),u(s),()=>{i.delete(o),i.size===0&&(t(),t=null)}}return{set:n,update:r,subscribe:h}}const Xe=ye({hit1:new Audio("sounds/hit1.wav"),hit2:new Audio("sounds/hit2.mp3"),treasure:new Audio("sounds/treasure.wav"),newLevel:new Audio("sounds/newLevel.wav"),spell:new Audio("sounds/spell.wav")});function R(s){const e=ae(Xe)[s];e.currentTime=0,e.play()}const K=class{constructor(e,t,i){l(this,"_isPlayer",!1);l(this,"_isAlive",!0);l(this,"_hasAttackedThisTurn",!1);l(this,"_isStunned",!1);l(this,"_teleportCounter",2);l(this,"_offsetX",0);l(this,"_offsetY",0);l(this,"_tile");l(this,"_sprite");l(this,"_health");this.move(e),this._sprite=t,this._health=i}update(e,t,i){if(this._teleportCounter--,!(this._teleportCounter>0)){if(this._isStunned){this._isStunned=!1;return}this.doEntityBehavior(e,t,i)}}tryToMove(e){if(e.isPassable){if(!e.entity)this.move(e);else if(e.entity.isPlayer!==this._isPlayer){this._hasAttackedThisTurn=!0,e.entity._isStunned=!0,e.entity.receiveDamage(1);const{x:t,y:i}=this._tile.coordinates,{x:n,y:r}=e.coordinates;this.bumpAnimation(n,t,r,i)}return!0}}receiveDamage(e){this._health-=e,this._health<=0&&this.die(),this._isPlayer?R("hit1"):R("hit2")}receiveHealth(e){this._health=Math.min(K.maxHealth,this._health+e)}smoothMoveAnimation(){this._offsetX-=Math.sign(this._offsetX)*(1/8),this._offsetY-=Math.sign(this._offsetY)*(1/8)}get offsetX(){return this._offsetX}get offsetY(){return this._offsetY}get displayCoordinates(){const{x:e,y:t}=this._tile.coordinates;return{x:e+this._offsetX,y:t+this._offsetY}}get teleportCounter(){return this._teleportCounter}get isStunned(){return this._isStunned}get tile(){return this._tile}get isAlive(){return this._isAlive}get isPlayer(){return this._isPlayer}get health(){return this._health}set health(e){this._health=e}get sprite(){return this._sprite}bumpAnimation(e,t,i,n){this._offsetX=(e-t)/2,this._offsetY=(i-n)/2}move(e){if(this._tile){this._tile.entity=null;const{x:t,y:i}=this._tile.coordinates,{x:n,y:r}=e.coordinates;this._offsetX=t-n,this._offsetY=i-r}this._tile=e,e.entity=this}doEntityBehavior(e,t,i){const n=e.filter(r=>r.isPassable&&(!r.entity||r.entity.isPlayer));if(n.length){n.sort((o,x)=>o.distance(t._tile)-x.distance(t._tile));const{x:r,y:h}=n[0].coordinates,{x:u,y:d}=this._tile.coordinates;this.tryToMove(i(this._tile,r-u,h-d))}}die(){this._isAlive=!1,this._tile.entity=null,this._sprite=1}};let b=K;l(b,"maxHealth",6);class Ye extends b{constructor(e){super(e,4,3)}}class je extends b{constructor(e){super(e,5,1)}doEntityBehavior(e,t,i){this._hasAttackedThisTurn=!1,super.doEntityBehavior(e,t,i),this._hasAttackedThisTurn||super.doEntityBehavior(e,t,i)}}class Ie extends b{constructor(e){super(e,6,2)}doEntityBehavior(e,t,i){let n=e.filter(r=>r.isPassable&&(!r.entity||r.entity.isPlayer));if(n.length){const{x:r,y:h}=n[0].coordinates,{x:u,y:d}=this._tile.coordinates;this.tryToMove(i(this._tile,r-u,h-d))}}}class Be extends b{constructor(e){super(e,7,1)}doEntityBehavior(e,t,i){const n=e.filter(r=>!r.isPassable&&_.inBounds(r.coordinates.x,r.coordinates.y));n.length?(n[0].replace(ge),this.receiveHealth(.5)):super.doEntityBehavior(e,t,i)}}class Fe extends b{constructor(e){super(e,8,3)}update(e,t,i){let n=this._isStunned;super.update(e,t,i),n||(this._isStunned=!0)}}var D=(s=>(s.HEALING_AURA="Healing Aura",s.TELEPORT="Teleport",s.FIRE="Fire",s))(D||{});class q{constructor(){l(this,"_spellName")}castSpell(e){}get spellName(){return this._spellName}}class ze{static newSpell(e){switch(e){case"Healing Aura":return new De;case"Teleport":return new Ge;case"Fire":return new We}}}class De extends q{constructor(){super(...arguments);l(this,"_spellName","Healing Aura")}castSpell(t){t.map.getAdjacentTiles(t.player.tile).forEach(i=>{i.effect=13,i.entity&&i.entity.receiveHealth(1)}),t.player.tile.effect=13,t.player.receiveHealth(1)}}class Ge extends q{constructor(){super(...arguments);l(this,"_spellName","Teleport")}castSpell(t){t.tryToMovePlayer(t.map.getRandomPassableTile())}}class We extends q{constructor(){super(...arguments);l(this,"_spellName","Fire")}castSpell(t){t.map.getAdjacentTiles(t.player.tile).forEach(i=>{i.effect=14,i.entity&&i.entity.receiveDamage(1)})}}class Ue extends b{constructor(t,i){super(t,0,i);l(this,"_isPlayer",!0);l(this,"_spells",[]);l(this,"_numberOfSpells",1);const n=H(Object.values(D)).splice(0,this._numberOfSpells);this.addSpells(n)}castSpell(t,i){this._spells[t]&&(this._spells[t].castSpell(i),delete this._spells[t],R("spell"))}addRandomSpell(){this.addSpells(H(Object.values(D)).slice(0,1))}set numberOfSpells(t){this._numberOfSpells=t}get numberOfSpells(){return this._numberOfSpells}get spells(){return this._spells}get spellNames(){return this._spells.map(t=>t.spellName)}addSpells(t){t.forEach(i=>{this._spells.push(ze.newSpell(i))})}}class qe{constructor(e){l(this,"_startingHealth",3);l(this,"_maxHealth",10);l(this,"_maxLevel",6);l(this,"_gameState",m.Loading);l(this,"_score",0);l(this,"_enemies",[]);l(this,"_level");l(this,"_map");l(this,"_player");l(this,"_spawnRate");l(this,"_spawnCounter");l(this,"_scoreStore");this._scoreStore=e}start(){this._score=0,this._level=1,this.startLevel(this._startingHealth),this._gameState=m.Running}movePlayer(e){let t=!1;switch(e){case v.UP:t=this.tryToMovePlayer(this._map.getTileAtDistanceXY(this._player.tile,0,-1));break;case v.DOWN:t=this.tryToMovePlayer(this._map.getTileAtDistanceXY(this._player.tile,0,1));break;case v.LEFT:t=this.tryToMovePlayer(this._map.getTileAtDistanceXY(this._player.tile,-1,0));break;case v.RIGHT:t=this.tryToMovePlayer(this._map.getTileAtDistanceXY(this._player.tile,1,0));break}t&&this.tick()}tryToMovePlayer(e){return e instanceof te&&!e.entity&&this.playerSteppedOnExitTile(),e.hasTreasure&&this.playerSteppedOnTreasure(e),this._player.tryToMove(e)}castSpell(e){this._player.castSpell(e,this)}startLevel(e){this._enemies=[],this._spawnRate=15,this._spawnCounter=this._spawnRate,this.generateLevel(),this._player=new Ue(this._map.getRandomPassableTile(),e),this._map.getRandomPassableTile().replace(te)}get score(){return this._score}get gameState(){return this._gameState}set gameState(e){this._gameState=e}get player(){return this._player}get map(){return this._map}get enemies(){return this._enemies}get maxHealth(){return this._maxHealth}get level(){return this._level}set level(e){this._level=e}get maxLevel(){return this._maxLevel}addScore(e){let t=this._scoreStore.get(),i={score:this._score,run:1,totalScore:this._score,active:e},n=t.pop();n&&(n.active?(i.run=n.run+1,i.totalScore+=n.totalScore):t.push(n)),t.push(i),this._scoreStore.set(t)}tick(){for(let e=this._enemies.length-1;e>=0;e--){const t=this._enemies[e];t.isAlive?t.update(this._map.getAdjacentTiles(t.tile),this._player,this._map.getTileAtDistanceXY.bind(this._map)):this.removeEnemy(e)}this._player.isAlive||(this.addScore(!1),this._gameState=m.GameOver),this._spawnCounter--,this._spawnCounter<=0&&(this.spawnEnemies(),this._spawnCounter=this._spawnRate,this._spawnRate--)}playerSteppedOnExitTile(){R("newLevel"),this._level==this._maxLevel?(this.addScore(!0),this._gameState=m.GameOver):(this._level+=1,this.startLevel(Math.min(this._maxHealth,this._player.health+1)))}playerSteppedOnTreasure(e){R("treasure"),this._score+=1,this._score%3==0&&this._player.numberOfSpells<9&&(this._player.numberOfSpells++,this._player.addRandomSpell()),e.hasTreasure=!1,this.spawnEnemies()}removeEnemy(e){this._enemies.splice(e,1)}generateLevel(){this._map=new _,this.generateEnemies(),this.generateTreasures()}generateTreasures(){for(let e=0;e<3;e++)this._map.getRandomPassableTile().hasTreasure=!0}generateEnemies(){let e=this._level+1;for(let t=0;t<e;t++)this.spawnEnemies()}spawnEnemies(){let e=H([Ye,je,Ie,Be,Fe])[0];this._enemies.push(new e(this._map.getRandomPassableTile()))}}var v=(s=>(s[s.UP=0]="UP",s[s.DOWN=1]="DOWN",s[s.LEFT=2]="LEFT",s[s.RIGHT=3]="RIGHT",s))(v||{}),m=(s=>(s.Title="title",s.GameOver="gameOver",s.Running="running",s.Loading="loading",s))(m||{});const Ke=(s,e)=>{const t=h=>JSON.stringify(h,null,2),i=JSON.parse;localStorage.getItem(s)===null&&localStorage.setItem(s,t(e));const n=i(localStorage.getItem(s)),r=ye(n);return{subscribe:r.subscribe,set:h=>(localStorage.setItem(s,t(h)),r.set(h)),update:r.update,get:()=>ae(r)}},se=Ke("scores",[]);function Je(s){let e,t,i;return{c(){e=ue("canvas"),ce(e,"class","svelte-7suhn9")},m(n,r){oe(n,e,r),s[2](e),t||(i=Pe(window,"keydown",Ae(s[1])),t=!0)},p:g,i:g,o:g,d(n){n&&W(e),s[2](null),t=!1,i()}}}function ie(s){let e="";return s.forEach(t=>{t+="";for(let i=t.length;i<10;i++)t+=" ";e+=t}),e}function Qe(s,e,t){let i;xe(s,se,a=>t(6,i=a));let n,r;const h=new Image;h.src="spritesheet.png",h.onload=o;const u=new qe(se);function d(a){switch(u.gameState){case m.Title:u.start();break;case m.GameOver:o();break;case m.Running:a.key=="w"&&u.movePlayer(v.UP),a.key=="s"&&u.movePlayer(v.DOWN),a.key=="a"&&u.movePlayer(v.LEFT),a.key=="d"&&u.movePlayer(v.RIGHT),parseInt(a.key)>=1&&parseInt(a.key)<=9&&u.castSpell(parseInt(a.key)-1);break}}function o(){r.fillStyle="rgba(0,0,0,.75)",r.fillRect(0,0,n.width,n.height),u.gameState=m.Title,S("a simple",40,!0,n.height/2-110,"white"),S("ROGUELIKE",70,!0,n.height/2-50,"white"),Te()}function x(){(u.gameState===m.Running||u.gameState===m.GameOver)&&(r.clearRect(0,0,n.width,n.height),M(),L(),y(),S("Level: "+u.level,30,!1,40,"#bd516d"),S("Score: "+u.score,30,!1,70,"#bd516d"))}function y(){for(let a=0;a<u.enemies.length;a++){const p=u.enemies[a],{x:c,y:f}=p.displayCoordinates;p.teleportCounter>0?T(10,c,f):(T(p.sprite,c,f),J(p,c,f)),p.smoothMoveAnimation()}}function L(){const a=u.player,{x:p,y:c}=a.displayCoordinates;T(a.sprite,p,c),J(a,p,c),a.smoothMoveAnimation();for(let f=0;f<a.spellNames.length;f++){let w=f+1+") "+(a.spellNames[f]||"");S(w,20,!1,110+f*40,"#81c0c6")}}function M(){for(let a=0;a<_.numTiles;a++)for(let p=0;p<_.numTiles;p++){const c=u.map.getTile(a,p),{x:f,y:w}=c.coordinates;T(c.sprite,f,w),c.hasTreasure&&T(12,f,w),c.effectCounter&&(c.effectCounter-=1,r.globalAlpha=c.effectCounter/30,T(c.effect,f,w),r.globalAlpha=1)}}function T(a,p,c){r.drawImage(h,a*16,0,16,16,p*_.tileSize,c*_.tileSize,_.tileSize,_.tileSize)}function J(a,p,c){for(let f=0;f<a.health;f++)T(9,p+f%3*(4/16),c-Math.floor(f/3)*(5/16))}function Te(){let a=i;if(a.length){S(ie(["RUN","SCORE","TOTAL"]),18,!0,n.height/2,"white");let p=a.pop();a.sort((c,f)=>f.totalScore-c.totalScore),a.unshift(p);for(let c=0;c<Math.min(10,a.length);c++){let f=ie([a[c].run.toString(),a[c].score.toString(),a[c].totalScore.toString()]);S(f,18,!0,n.height/2+24+c*24,c===0?"#81c0c6":"#e5858c")}}}function S(a,p,c,f,w){r.fillStyle=w,r.font=p+"px monospace";let Y;c?Y=(n.width-r.measureText(a).width)/2:Y=_.tileSize*_.numTiles+25,r.fillText(a,Y,f)}$e(()=>{r=n.getContext("2d"),t(0,n.width=_.tileSize*(_.numTiles+_.uiWidth),n),t(0,n.height=_.tileSize*_.numTiles,n),t(0,n.style.width=n.width+"px",n),t(0,n.style.height=n.height+"px",n),r.imageSmoothingEnabled=!1});function ve(a){I[a?"unshift":"push"](()=>{n=a,t(0,n)})}return setInterval(x,15),[n,d,ve]}class Ve extends me{constructor(e){super(),de(this,e,Qe,Je,G,{})}}function Ze(s){let e,t,i;return t=new Ve({}),{c(){e=ue("main"),ke(t.$$.fragment),ce(e,"class","svelte-cuxfl6")},m(n,r){oe(n,e,r),_e(t,e,null),i=!0},p:g,i(n){i||(fe(t.$$.fragment,n),i=!0)},o(n){Ne(t.$$.fragment,n),i=!1},d(n){n&&W(e),pe(t)}}}class et extends me{constructor(e){super(),de(this,e,null,Ze,G,{})}}new et({target:document.body});
