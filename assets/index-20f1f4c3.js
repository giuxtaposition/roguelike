var ve=Object.defineProperty;var be=(s,e,t)=>e in s?ve(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var a=(s,e,t)=>(be(s,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerpolicy&&(r.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?r.credentials="include":n.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();function y(){}function te(s){return s()}function q(){return Object.create(null)}function X(s){s.forEach(te)}function se(s){return typeof s=="function"}function z(s,e){return s!=s?e==e:s!==e||s&&typeof s=="object"||typeof s=="function"}function we(s){return Object.keys(s).length===0}function ie(s,...e){if(s==null)return y;const t=s.subscribe(...e);return t.unsubscribe?()=>t.unsubscribe():t}function ne(s){let e;return ie(s,t=>e=t)(),e}function Se(s,e,t){s.$$.on_destroy.push(ie(e,t))}function re(s,e,t){s.insertBefore(e,t||null)}function D(s){s.parentNode&&s.parentNode.removeChild(s)}function oe(s){return document.createElement(s)}function _e(s,e,t,i){return s.addEventListener(e,t,i),()=>s.removeEventListener(e,t,i)}function xe(s){return function(e){return e.preventDefault(),s.call(this,e)}}function ae(s,e,t){t==null?s.removeAttribute(e):s.getAttribute(e)!==t&&s.setAttribute(e,t)}function Ee(s){return Array.from(s.childNodes)}let M;function A(s){M=s}function Pe(){if(!M)throw new Error("Function called outside component initialization");return M}function Ce(s){Pe().$$.on_mount.push(s)}const P=[],j=[],I=[],K=[],Ae=Promise.resolve();let G=!1;function Me(){G||(G=!0,Ae.then(le))}function B(s){I.push(s)}const Y=new Set;let x=0;function le(){if(x!==0)return;const s=M;do{try{for(;x<P.length;){const e=P[x];x++,A(e),Oe(e.$$)}}catch(e){throw P.length=0,x=0,e}for(A(null),P.length=0,x=0;j.length;)j.pop()();for(let e=0;e<I.length;e+=1){const t=I[e];Y.has(t)||(Y.add(t),t())}I.length=0}while(P.length);for(;K.length;)K.pop()();G=!1,Y.clear(),A(s)}function Oe(s){if(s.fragment!==null){s.update(),X(s.before_update);const e=s.dirty;s.dirty=[-1],s.fragment&&s.fragment.p(s.ctx,e),s.after_update.forEach(B)}}const R=new Set;let $e;function ue(s,e){s&&s.i&&(R.delete(s),s.i(e))}function Le(s,e,t,i){if(s&&s.o){if(R.has(s))return;R.add(s),$e.c.push(()=>{R.delete(s),i&&(t&&s.d(1),i())}),s.o(e)}else i&&i()}function Ie(s){s&&s.c()}function ce(s,e,t,i){const{fragment:n,after_update:r}=s.$$;n&&n.m(e,t),i||B(()=>{const c=s.$$.on_mount.map(te).filter(se);s.$$.on_destroy?s.$$.on_destroy.push(...c):X(c),s.$$.on_mount=[]}),r.forEach(B)}function he(s,e){const t=s.$$;t.fragment!==null&&(X(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function Re(s,e){s.$$.dirty[0]===-1&&(P.push(s),Me(),s.$$.dirty.fill(0)),s.$$.dirty[e/31|0]|=1<<e%31}function fe(s,e,t,i,n,r,c,u=[-1]){const m=M;A(s);const l=s.$$={fragment:null,ctx:[],props:r,update:y,not_equal:n,bound:q(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(m?m.$$.context:[])),callbacks:q(),dirty:u,skip_bound:!1,root:e.target||m.$$.root};c&&c(l.root);let S=!1;if(l.ctx=t?t(s,e.props||{},(T,O,...$)=>{const v=$.length?$[0]:O;return l.ctx&&n(l.ctx[T],l.ctx[T]=v)&&(!l.skip_bound&&l.bound[T]&&l.bound[T](v),S&&Re(s,T)),O}):[],l.update(),S=!0,X(l.before_update),l.fragment=i?i(l.ctx):!1,e.target){if(e.hydrate){const T=Ee(e.target);l.fragment&&l.fragment.l(T),T.forEach(D)}else l.fragment&&l.fragment.c();e.intro&&ue(s.$$.fragment),ce(s,e.target,e.anchor,e.customElement),le()}A(m)}class de{$destroy(){he(this,1),this.$destroy=y}$on(e,t){if(!se(t))return y;const i=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return i.push(t),()=>{const n=i.indexOf(t);n!==-1&&i.splice(n,1)}}$set(e){this.$$set&&!we(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}function J(s,e){for(let t=1e3;t>0;t--)if(e())return;throw"Timeout while trying to "+s}function N(s,e){return Math.floor(Math.random()*(e-s+1))+s}function ge(s){let e,t;for(let i=1;i<s.length;i++)t=N(0,i),e=s[i],s[i]=s[t],s[t]=e;return s}class W{constructor(e,t,i,n,r){a(this,"x");a(this,"y");a(this,"sprite");a(this,"isPassable");a(this,"entity");a(this,"map");a(this,"treasure",!1);this.x=e,this.y=t,this.sprite=i,this.isPassable=n,this.map=r}distance(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}replace(e){this.map.getTiles()[this.x][this.y]=new e(this.x,this.y,this.map)}getTreasure(){return this.treasure}setTreasure(e){this.treasure=e}getEntity(){return this.entity}setEntity(e){this.entity=e}getCoordinates(){return{x:this.x,y:this.y}}getIsPassable(){return this.isPassable}getSprite(){return this.sprite}}class me extends W{constructor(e,t,i){super(e,t,2,!0,i)}}class Q extends W{constructor(e,t,i){super(e,t,3,!1,i)}}class V extends W{constructor(e,t,i){super(e,t,11,!0,i)}}var C;let f=(C=class{constructor(){a(this,"tiles",[]);J("generate map",()=>this.generateTiles()==this.getConnectedTiles(this.getRandomPassableTile()).length)}getTileAtDistanceXY(e,t,i){const{x:n,y:r}=e.getCoordinates();return this.getTile(n+t,r+i)}getAdjacentPassableTiles(e){return this.getAdjacentTiles(e).filter(t=>t.getIsPassable())}getRandomPassableTile(){let e;return J("get random passable tile",()=>{let t=N(0,f.numTiles-1),i=N(0,f.numTiles-1);return e=this.getTile(t,i),e.getIsPassable()}),e}getTile(e,t){return f.inBounds(e,t)?this.tiles[e][t]:new Q(e,t,this)}getAdjacentTiles(e){const{x:t,y:i}=e.getCoordinates();return ge([this.getTile(t,i-1),this.getTile(t,i+1),this.getTile(t-1,i),this.getTile(t+1,i)])}getTiles(){return this.tiles}static inBounds(e,t){return e>0&&t>0&&e<f.numTiles-1&&t<f.numTiles-1}generateTiles(){let e=0;for(let t=0;t<f.numTiles;t++){this.tiles[t]=[];for(let i=0;i<f.numTiles;i++)Math.random()<.3||!f.inBounds(t,i)?this.tiles[t][i]=new Q(t,i,this):(this.tiles[t][i]=new me(t,i,this),e++)}return e}getConnectedTiles(e){let t=[e],i=[e];for(;i.length;){let n=i.pop(),r=this.getAdjacentPassableTiles(n).filter(c=>!t.includes(c));t=t.concat(r),i=i.concat(r)}return t}},a(C,"tileSize",64),a(C,"numTiles",12),a(C,"uiWidth",4),C);const E=[];function pe(s,e=y){let t;const i=new Set;function n(u){if(z(s,u)&&(s=u,t)){const m=!E.length;for(const l of i)l[1](),E.push(l,s);if(m){for(let l=0;l<E.length;l+=2)E[l][0](E[l+1]);E.length=0}}}function r(u){n(u(s))}function c(u,m=y){const l=[u,m];return i.add(l),i.size===1&&(t=e(n)||y),u(s),()=>{i.delete(l),i.size===0&&(t(),t=null)}}return{set:n,update:r,subscribe:c}}const ke=pe({hit1:new Audio("sounds/hit1.wav"),hit2:new Audio("sounds/hit2.mp3"),treasure:new Audio("sounds/treasure.wav"),newLevel:new Audio("sounds/newLevel.wav")});function k(s){const e=ne(ke)[s];e.currentTime=0,e.play()}const F=class{constructor(e,t,i){a(this,"tile");a(this,"sprite");a(this,"health");a(this,"isPlayer",!1);a(this,"isAlive",!0);a(this,"hasAttackedThisTurn",!1);a(this,"isStunned",!1);a(this,"teleportCounter",2);a(this,"offsetX",0);a(this,"offsetY",0);this.move(e),this.sprite=t,this.health=i}update(e,t,i){if(this.teleportCounter--,!(this.teleportCounter>0)){if(this.isStunned){this.isStunned=!1;return}this.doEntityBehavior(e,t,i)}}tryToMove(e){if(e.getIsPassable()){if(!e.getEntity())this.move(e);else if(e.getEntity().getIsPlayer()!==this.isPlayer){this.hasAttackedThisTurn=!0,e.getEntity().isStunned=!0,e.getEntity().receiveDamage(1);const{x:t,y:i}=this.tile.getCoordinates(),{x:n,y:r}=e.getCoordinates();this.bumpAnimation(n,t,r,i)}return!0}}receiveDamage(e){this.health-=e,this.health<=0&&this.die(),this.isPlayer?k("hit1"):k("hit2")}getTeleportCounter(){return this.teleportCounter}getIsStunned(){return this.isStunned}getTile(){return this.tile}getIsAlive(){return this.isAlive}getIsPlayer(){return this.isPlayer}getHealth(){return this.health}getSprite(){return this.sprite}smoothMoveAnimation(){this.offsetX-=Math.sign(this.offsetX)*(1/8),this.offsetY-=Math.sign(this.offsetY)*(1/8)}getOffsetX(){return this.offsetX}getOffsetY(){return this.offsetY}getDisplayCoordinates(){const{x:e,y:t}=this.tile.getCoordinates();return{x:e+this.offsetX,y:t+this.offsetY}}bumpAnimation(e,t,i,n){this.offsetX=(e-t)/2,this.offsetY=(i-n)/2}move(e){if(this.tile){this.tile.setEntity(null);const{x:t,y:i}=this.tile.getCoordinates(),{x:n,y:r}=e.getCoordinates();this.offsetX=t-n,this.offsetY=i-r}this.tile=e,e.setEntity(this)}doEntityBehavior(e,t,i){const n=e.filter(r=>r.getIsPassable()&&(!r.getEntity()||r.getEntity().getIsPlayer()));if(n.length){n.sort((l,S)=>l.distance(t.tile)-S.distance(t.tile));const{x:r,y:c}=n[0].getCoordinates(),{x:u,y:m}=this.tile.getCoordinates();this.tryToMove(i(this.getTile(),r-u,c-m))}}receiveHealth(e){this.health=Math.min(F.maxHealth,this.health+e)}die(){this.isAlive=!1,this.tile.setEntity(null),this.sprite=1}};let w=F;a(w,"maxHealth",6);class Xe extends w{constructor(e){super(e,4,3)}}class He extends w{constructor(e){super(e,5,1)}doEntityBehavior(e,t,i){this.hasAttackedThisTurn=!1,super.doEntityBehavior(e,t,i),this.hasAttackedThisTurn||super.doEntityBehavior(e,t,i)}}class Ye extends w{constructor(e){super(e,6,2)}doEntityBehavior(e,t,i){let n=e.filter(r=>r.getIsPassable()&&(!r.getEntity()||r.getEntity().getIsPlayer()));if(n.length){const{x:r,y:c}=n[0].getCoordinates(),{x:u,y:m}=this.tile.getCoordinates();this.tryToMove(i(this.getTile(),r-u,c-m))}}}class je extends w{constructor(e){super(e,7,1)}doEntityBehavior(e,t,i){const n=e.filter(r=>!r.getIsPassable()&&f.inBounds(r.getCoordinates().x,r.getCoordinates().y));n.length?(n[0].replace(me),this.receiveHealth(.5)):super.doEntityBehavior(e,t,i)}}class Ge extends w{constructor(e){super(e,8,3)}update(e,t,i){let n=this.isStunned;super.update(e,t,i),n||(this.isStunned=!0)}}class Be extends w{constructor(e,t){super(e,0,t),this.isPlayer=!0}}class Ne{constructor(e){a(this,"startingHealth",3);a(this,"maxHealth",10);a(this,"maxLevel",6);a(this,"gameState",p.Loading);a(this,"score",0);a(this,"enemies",[]);a(this,"level");a(this,"map");a(this,"player");a(this,"spawnRate");a(this,"spawnCounter");a(this,"scoreStore");this.scoreStore=e}start(){this.level=1,this.startLevel(this.startingHealth),this.gameState=p.Running}movePlayer(e){let t=!1;switch(e){case b.UP:t=this.tryToMovePlayer(0,-1);break;case b.DOWN:t=this.tryToMovePlayer(0,1);break;case b.LEFT:t=this.tryToMovePlayer(-1,0);break;case b.RIGHT:t=this.tryToMovePlayer(1,0);break}t&&this.tick()}getScore(){return this.score}getGameState(){return this.gameState}setGameState(e){this.gameState=e}getPlayer(){return this.player}getMap(){return this.map}getEnemies(){return this.enemies}getMaxHealth(){return this.maxHealth}getLevel(){return this.level}updateLevel(){this.level+=1}getMaxLevel(){return this.maxLevel}startLevel(e){this.enemies=[],this.spawnRate=15,this.spawnCounter=this.spawnRate,this.generateLevel(),this.player=new Be(this.map.getRandomPassableTile(),e),this.map.getRandomPassableTile().replace(V)}addScore(e){let t=this.scoreStore.get(),i={score:this.score,run:1,totalScore:this.score,active:e},n=t.pop();n&&(n.active?(i.run=n.run+1,i.totalScore+=n.totalScore):t.push(n)),t.push(i),this.scoreStore.set(t)}tick(){for(let e=this.enemies.length-1;e>=0;e--){const t=this.enemies[e];t.getIsAlive()?t.update(this.map.getAdjacentTiles(t.getTile()),this.player,this.map.getTileAtDistanceXY.bind(this.map)):this.removeEnemy(e)}this.player.getIsAlive()||(this.addScore(!1),this.gameState=p.GameOver),this.spawnCounter--,this.spawnCounter<=0&&(this.spawnEnemies(),this.spawnCounter=this.spawnRate,this.spawnRate--)}tryToMovePlayer(e,t){const i=this.map.getTileAtDistanceXY(this.player.getTile(),e,t);return i instanceof V&&!i.getEntity()&&this.playerSteppedOnExitTile(),i.getTreasure()&&this.playerSteppedOnTreasure(i),this.player.tryToMove(i)}playerSteppedOnExitTile(){k("newLevel"),this.level==this.maxLevel?(this.addScore(!0),this.setGameState(p.GameOver)):(this.level+=1,this.startLevel(Math.min(this.maxHealth,this.player.getHealth()+1)))}playerSteppedOnTreasure(e){k("treasure"),this.score+=1,e.setTreasure(!1),this.spawnEnemies()}removeEnemy(e){this.enemies.splice(e,1)}generateLevel(){this.map=new f,this.generateEnemies(),this.generateTreasures()}generateTreasures(){for(let e=0;e<3;e++)this.map.getRandomPassableTile().setTreasure(!0)}generateEnemies(){let e=this.level+1;for(let t=0;t<e;t++)this.spawnEnemies()}spawnEnemies(){let e=ge([Xe,He,Ye,je,Ge])[0];this.enemies.push(new e(this.map.getRandomPassableTile()))}}var b=(s=>(s[s.UP=0]="UP",s[s.DOWN=1]="DOWN",s[s.LEFT=2]="LEFT",s[s.RIGHT=3]="RIGHT",s))(b||{}),p=(s=>(s.Title="title",s.GameOver="gameOver",s.Running="running",s.Loading="loading",s))(p||{});const ze=(s,e)=>{const t=c=>JSON.stringify(c,null,2),i=JSON.parse;localStorage.getItem(s)===null&&localStorage.setItem(s,t(e));const n=i(localStorage.getItem(s)),r=pe(n);return{subscribe:r.subscribe,set:c=>(localStorage.setItem(s,t(c)),r.set(c)),update:r.update,get:()=>ne(r)}},Z=ze("scores",[]);function De(s){let e,t,i;return{c(){e=oe("canvas"),ae(e,"class","svelte-7suhn9")},m(n,r){re(n,e,r),s[2](e),t||(i=_e(window,"keydown",xe(s[1])),t=!0)},p:y,i:y,o:y,d(n){n&&D(e),s[2](null),t=!1,i()}}}function ee(s){let e="";return s.forEach(t=>{t+="";for(let i=t.length;i<10;i++)t+=" ";e+=t}),e}function We(s,e,t){let i;Se(s,Z,o=>t(5,i=o));let n,r;const c=new Image;c.src="spritesheet.png",c.onload=l;const u=new Ne(Z);function m(o){switch(u.getGameState()){case p.Title:u.start();break;case p.GameOver:l();break;case p.Running:o.key=="w"&&u.movePlayer(b.UP),o.key=="s"&&u.movePlayer(b.DOWN),o.key=="a"&&u.movePlayer(b.LEFT),o.key=="d"&&u.movePlayer(b.RIGHT);break}}function l(){r.fillStyle="rgba(0,0,0,.75)",r.fillRect(0,0,n.width,n.height),u.setGameState(p.Title),_("a simple",40,!0,n.height/2-110,"white"),_("ROGUELIKE",70,!0,n.height/2-50,"white"),ye()}function S(){(u.getGameState()===p.Running||u.getGameState()===p.GameOver)&&(r.clearRect(0,0,n.width,n.height),$(),O(),T(),_("Level: "+u.getLevel(),30,!1,40,"#bd516d"),_("Score: "+u.getScore(),30,!1,70,"#bd516d"))}function T(){for(let o=0;o<u.getEnemies().length;o++){const d=u.getEnemies()[o],{x:h,y:g}=d.getDisplayCoordinates();d.getTeleportCounter()>0?v(10,h,g):(v(d.getSprite(),h,g),U(d,h,g)),d.smoothMoveAnimation()}}function O(){const o=u.getPlayer(),{x:d,y:h}=o.getDisplayCoordinates();v(o.getSprite(),d,h),U(o,d,h),o.smoothMoveAnimation()}function $(){for(let o=0;o<f.numTiles;o++)for(let d=0;d<f.numTiles;d++){const h=u.getMap().getTile(o,d),{x:g,y:L}=h.getCoordinates();v(h.getSprite(),g,L),h.getTreasure()&&v(12,g,L)}}function v(o,d,h){r.drawImage(c,o*16,0,16,16,d*f.tileSize,h*f.tileSize,f.tileSize,f.tileSize)}function U(o,d,h){for(let g=0;g<o.getHealth();g++)v(9,d+g%3*(4/16),h-Math.floor(g/3)*(5/16))}function ye(){let o=i;if(o.length){_(ee(["RUN","SCORE","TOTAL"]),18,!0,n.height/2,"white");let d=o.pop();o.sort((h,g)=>g.totalScore-h.totalScore),o.unshift(d);for(let h=0;h<Math.min(10,o.length);h++){let g=ee([o[h].run.toString(),o[h].score.toString(),o[h].totalScore.toString()]);_(g,18,!0,n.height/2+24+h*24,h===0?"#81c0c6":"#e5858c")}}}function _(o,d,h,g,L){r.fillStyle=L,r.font=d+"px monospace";let H;h?H=(n.width-r.measureText(o).width)/2:H=f.tileSize*f.numTiles+25,r.fillText(o,H,g)}Ce(()=>{r=n.getContext("2d"),t(0,n.width=f.tileSize*(f.numTiles+f.uiWidth),n),t(0,n.height=f.tileSize*f.numTiles,n),t(0,n.style.width=n.width+"px",n),t(0,n.style.height=n.height+"px",n),r.imageSmoothingEnabled=!1});function Te(o){j[o?"unshift":"push"](()=>{n=o,t(0,n)})}return setInterval(S,15),[n,m,Te]}class Fe extends de{constructor(e){super(),fe(this,e,We,De,z,{})}}function Ue(s){let e,t,i;return t=new Fe({}),{c(){e=oe("main"),Ie(t.$$.fragment),ae(e,"class","svelte-cuxfl6")},m(n,r){re(n,e,r),ce(t,e,null),i=!0},p:y,i(n){i||(ue(t.$$.fragment,n),i=!0)},o(n){Le(t.$$.fragment,n),i=!1},d(n){n&&D(e),he(t)}}}class qe extends de{constructor(e){super(),fe(this,e,null,Ue,z,{})}}new qe({target:document.body});
