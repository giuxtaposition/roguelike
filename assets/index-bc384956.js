var le=Object.defineProperty;var ae=(t,e,s)=>e in t?le(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var a=(t,e,s)=>(ae(t,typeof e!="symbol"?e+"":e,s),s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function s(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=s(i);fetch(i.href,r)}})();function b(){}function D(t){return t()}function N(){return Object.create(null)}function C(t){t.forEach(D)}function W(t){return typeof t=="function"}function F(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function oe(t){return Object.keys(t).length===0}function U(t,e,s){t.insertBefore(e,s||null)}function j(t){t.parentNode&&t.parentNode.removeChild(t)}function K(t){return document.createElement(t)}function ue(t,e,s,n){return t.addEventListener(e,s,n),()=>t.removeEventListener(e,s,n)}function ce(t){return function(e){return e.preventDefault(),t.call(this,e)}}function he(t,e,s){s==null?t.removeAttribute(e):t.getAttribute(e)!==s&&t.setAttribute(e,s)}function fe(t){return Array.from(t.childNodes)}let A;function $(t){A=t}function de(){if(!A)throw new Error("Function called outside component initialization");return A}function ge(t){de().$$.on_mount.push(t)}const x=[],O=[],k=[],X=[],me=Promise.resolve();let R=!1;function pe(){R||(R=!0,me.then(q))}function B(t){k.push(t)}const L=new Set;let E=0;function q(){if(E!==0)return;const t=A;do{try{for(;E<x.length;){const e=x[E];E++,$(e),ye(e.$$)}}catch(e){throw x.length=0,E=0,e}for($(null),x.length=0,E=0;O.length;)O.pop()();for(let e=0;e<k.length;e+=1){const s=k[e];L.has(s)||(L.add(s),s())}k.length=0}while(x.length);for(;X.length;)X.pop()();R=!1,L.clear(),$(t)}function ye(t){if(t.fragment!==null){t.update(),C(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(B)}}const M=new Set;let Te;function J(t,e){t&&t.i&&(M.delete(t),t.i(e))}function ve(t,e,s,n){if(t&&t.o){if(M.has(t))return;M.add(t),Te.c.push(()=>{M.delete(t),n&&(s&&t.d(1),n())}),t.o(e)}else n&&n()}function _e(t){t&&t.c()}function Q(t,e,s,n){const{fragment:i,after_update:r}=t.$$;i&&i.m(e,s),n||B(()=>{const l=t.$$.on_mount.map(D).filter(W);t.$$.on_destroy?t.$$.on_destroy.push(...l):C(l),t.$$.on_mount=[]}),r.forEach(B)}function V(t,e){const s=t.$$;s.fragment!==null&&(C(s.on_destroy),s.fragment&&s.fragment.d(e),s.on_destroy=s.fragment=null,s.ctx=[])}function be(t,e){t.$$.dirty[0]===-1&&(x.push(t),pe(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function Z(t,e,s,n,i,r,l,v=[-1]){const f=A;$(t);const c=t.$$={fragment:null,ctx:[],props:r,update:b,not_equal:i,bound:N(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(f?f.$$.context:[])),callbacks:N(),dirty:v,skip_bound:!1,root:e.target||f.$$.root};l&&l(c.root);let w=!1;if(c.ctx=s?s(t,e.props||{},(d,I,..._)=>{const P=_.length?_[0]:I;return c.ctx&&i(c.ctx[d],c.ctx[d]=P)&&(!c.skip_bound&&c.bound[d]&&c.bound[d](P),w&&be(t,d)),I}):[],c.update(),w=!0,C(c.before_update),c.fragment=n?n(c.ctx):!1,e.target){if(e.hydrate){const d=fe(e.target);c.fragment&&c.fragment.l(d),d.forEach(j)}else c.fragment&&c.fragment.c();e.intro&&J(t.$$.fragment),Q(t,e.target,e.anchor,e.customElement),q()}$(f)}class ee{$destroy(){V(this,1),this.$destroy=b}$on(e,s){if(!W(s))return b;const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(s),()=>{const i=n.indexOf(s);i!==-1&&n.splice(i,1)}}$set(e){this.$$set&&!oe(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}function Y(t,e){for(let s=1e3;s>0;s--)if(e())return;throw"Timeout while trying to "+t}function H(t,e){return Math.floor(Math.random()*(e-t+1))+t}function te(t){let e,s;for(let n=1;n<t.length;n++)s=H(0,n),e=t[n],t[n]=t[s],t[s]=e;return t}class se{constructor(e,s,n,i,r){a(this,"x");a(this,"y");a(this,"sprite");a(this,"isPassable");a(this,"entity");a(this,"map");this.x=e,this.y=s,this.sprite=n,this.isPassable=i,this.map=r}distance(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}replace(e){this.map.getTiles()[this.x][this.y]=new e(this.x,this.y,this.map)}getEntity(){return this.entity}setEntity(e){this.entity=e}getCoordinates(){return{x:this.x,y:this.y}}getIsPassable(){return this.isPassable}getSprite(){return this.sprite}}class ne extends se{constructor(e,s,n){super(e,s,2,!0,n)}}class z extends se{constructor(e,s,n){super(e,s,3,!1,n)}}var S;let u=(S=class{constructor(){a(this,"tiles",[]);Y("generate map",()=>this.generateTiles()==this.getConnectedTiles(this.getRandomPassableTile()).length)}getAdjacentPassableTiles(e){return this.getAdjacentTiles(e).filter(s=>s.getIsPassable())}getRandomPassableTile(){let e;return Y("get random passable tile",()=>{let s=H(0,u.numTiles-1),n=H(0,u.numTiles-1);return e=this.getTile(s,n),e.getIsPassable()}),e}getTile(e,s){return u.inBounds(e,s)?this.tiles[e][s]:new z(e,s,this)}getAdjacentTiles(e){const{x:s,y:n}=e.getCoordinates();return te([this.getTile(s,n-1),this.getTile(s,n+1),this.getTile(s-1,n),this.getTile(s+1,n)])}getTiles(){return this.tiles}static inBounds(e,s){return e>0&&s>0&&e<u.numTiles-1&&s<u.numTiles-1}generateTiles(){let e=0;for(let s=0;s<u.numTiles;s++){this.tiles[s]=[];for(let n=0;n<u.numTiles;n++)Math.random()<.3||!u.inBounds(s,n)?this.tiles[s][n]=new z(s,n,this):(this.tiles[s][n]=new ne(s,n,this),e++)}return e}getConnectedTiles(e){let s=[e],n=[e];for(;n.length;){let i=n.pop(),r=this.getAdjacentPassableTiles(i).filter(l=>!s.includes(l));s=s.concat(r),n=n.concat(r)}return s}},a(S,"tileSize",64),a(S,"numTiles",9),a(S,"uiWidth",4),S);const G=class{constructor(e,s,n){a(this,"tile");a(this,"sprite");a(this,"health");a(this,"isPlayer",!1);a(this,"isAlive",!0);a(this,"hasAttackedThisTurn",!1);a(this,"isStunned",!1);this.move(e),this.sprite=s,this.health=n}update(e,s,n){if(this.isStunned){this.isStunned=!1;return}this.doEntityBehavior(e,s,n)}tryToMove(e){if(e.getIsPassable())return e.getEntity()?e.getEntity().getIsPlayer()!==this.isPlayer&&(this.hasAttackedThisTurn=!0,e.getEntity().isStunned=!0,e.getEntity().receiveDamage(1)):this.move(e),!0}receiveDamage(e){this.health-=e,this.health<=0&&this.die()}getIsStunned(){return this.isStunned}getTile(){return this.tile}getIsAlive(){return this.isAlive}getIsPlayer(){return this.isPlayer}getHealth(){return this.health}getSprite(){return this.sprite}move(e){this.tile&&this.tile.setEntity(null),this.tile=e,e.setEntity(this)}doEntityBehavior(e,s,n){const i=e.filter(r=>r.getIsPassable()&&(!r.getEntity()||r.getEntity().getIsPlayer()));if(i.length){i.sort((c,w)=>c.distance(s.tile)-w.distance(s.tile));const{x:r,y:l}=i[0].getCoordinates(),{x:v,y:f}=this.tile.getCoordinates();this.tryToMove(n(this,r-v,l-f))}}receiveHealth(e){this.health=Math.min(G.maxHealth,this.health+e)}die(){this.isAlive=!1,this.tile.setEntity(null),this.sprite=1}};let T=G;a(T,"maxHealth",6);class we extends T{constructor(e){super(e,4,3)}}class Ee extends T{constructor(e){super(e,5,1)}doEntityBehavior(e,s,n){this.hasAttackedThisTurn=!1,super.doEntityBehavior(e,s,n),this.hasAttackedThisTurn||super.doEntityBehavior(e,s,n)}}class xe extends T{constructor(e){super(e,6,2)}doEntityBehavior(e,s,n){let i=e.filter(r=>r.getIsPassable()&&(!r.getEntity()||r.getEntity().getIsPlayer()));if(i.length){const{x:r,y:l}=i[0].getCoordinates(),{x:v,y:f}=this.tile.getCoordinates();this.tryToMove(n(this,r-v,l-f))}}}class Pe extends T{constructor(e){super(e,7,1)}doEntityBehavior(e,s,n){const i=e.filter(r=>!r.getIsPassable()&&u.inBounds(r.getCoordinates().x,r.getCoordinates().y));i.length?(i[0].replace(ne),this.receiveHealth(.5)):super.doEntityBehavior(e,s,n)}}class Se extends T{constructor(e){super(e,8,3)}update(e,s,n){let i=this.isStunned;super.update(e,s,n),i||(this.isStunned=!0)}}class $e extends T{constructor(e,s){super(e,0,s),this.isPlayer=!0}}class Ae{constructor(){a(this,"level",1);a(this,"startingHp",3);a(this,"numLevels",6);a(this,"map");a(this,"enemies",[]);a(this,"player");a(this,"gameState",g.Loading)}start(){this.level=1,this.startLevel(this.startingHp),this.gameState=g.Running}movePlayer(e){let s=!1;switch(e){case y.UP:s=this.player.tryToMove(this.getTileAtDistanceXY(this.player,0,-1));break;case y.DOWN:s=this.player.tryToMove(this.getTileAtDistanceXY(this.player,0,1));break;case y.LEFT:s=this.player.tryToMove(this.getTileAtDistanceXY(this.player,-1,0));break;case y.RIGHT:s=this.player.tryToMove(this.getTileAtDistanceXY(this.player,1,0));break}s&&this.tick()}getGameState(){return this.gameState}setGameState(e){this.gameState=e}getPlayer(){return this.player}getMap(){return this.map}getEnemies(){return this.enemies}startLevel(e){this.generateLevel(),this.player=new $e(this.map.getRandomPassableTile(),e)}tick(){console.log("before for loop");for(let e=this.enemies.length-1;e>=0;e--){const s=this.enemies[e];s.getIsAlive()?s.update(this.map.getAdjacentTiles(s.getTile()),this.player,this.getTileAtDistanceXY.bind(this)):this.removeEnemy(e)}console.log("tick"),console.log("player is dead ",!this.player.getIsAlive()),this.player.getIsAlive()||(this.gameState=g.GameOver)}removeEnemy(e){this.enemies.splice(e,1)}getTileAtDistanceXY(e,s,n){const{x:i,y:r}=e.getTile().getCoordinates();return this.map.getTile(i+s,r+n)}generateLevel(){this.map=new u,this.generateEnemies()}generateEnemies(){let e=this.level+1;for(let s=0;s<e;s++)this.spawnEnemies()}spawnEnemies(){let e=te([we,Ee,xe,Pe,Se])[0];this.enemies.push(new e(this.map.getRandomPassableTile()))}}var y=(t=>(t[t.UP=0]="UP",t[t.DOWN=1]="DOWN",t[t.LEFT=2]="LEFT",t[t.RIGHT=3]="RIGHT",t))(y||{}),g=(t=>(t.Title="title",t.GameOver="gameOver",t.Running="running",t.Loading="loading",t))(g||{});function Ie(t){let e,s,n;return{c(){e=K("canvas"),he(e,"class","svelte-3f2pl5")},m(i,r){U(i,e,r),t[2](e),s||(n=ue(window,"keydown",ce(t[1])),s=!0)},p:b,i:b,o:b,d(i){i&&j(e),t[2](null),s=!1,n()}}}function ke(t,e,s){let n,i;const r=new Image;r.src="spritesheet.png",r.onload=f;const l=new Ae;function v(o){switch(l.getGameState()){case g.Title:l.start();break;case g.GameOver:f();break;case g.Running:o.key=="w"&&l.movePlayer(y.UP),o.key=="s"&&l.movePlayer(y.DOWN),o.key=="a"&&l.movePlayer(y.LEFT),o.key=="d"&&l.movePlayer(y.RIGHT);break}}function f(){i.fillStyle="rgba(0,0,0,.75)",i.fillRect(0,0,n.width,n.height),l.setGameState(g.Title)}function c(){(l.getGameState()===g.Running||l.getGameState()===g.GameOver)&&(i.clearRect(0,0,n.width,n.height),I(),d(),w())}function w(){for(let o=0;o<l.getEnemies().length;o++){const h=l.getEnemies()[o],{x:m,y:p}=h.getTile().getCoordinates();_(h.getSprite(),m,p),P(h,m,p)}}function d(){const{x:o,y:h}=l.getPlayer().getTile().getCoordinates();_(l.getPlayer().getSprite(),o,h),P(l.getPlayer(),o,h)}function I(){for(let o=0;o<u.numTiles;o++)for(let h=0;h<u.numTiles;h++){const m=l.getMap().getTile(o,h),{x:p,y:re}=m.getCoordinates();_(m.getSprite(),p,re)}}function _(o,h,m){i.drawImage(r,o*16,0,16,16,h*u.tileSize,m*u.tileSize,u.tileSize,u.tileSize)}function P(o,h,m){for(let p=0;p<o.getHealth();p++)_(9,h+p%3*(4/16),m-Math.floor(p/3)*(5/16))}ge(()=>{i=n.getContext("2d"),s(0,n.width=u.tileSize*(u.numTiles+u.uiWidth),n),s(0,n.height=u.tileSize*u.numTiles,n),s(0,n.style.width=n.width+"px",n),s(0,n.style.height=n.height+"px",n),i.imageSmoothingEnabled=!1});function ie(o){O[o?"unshift":"push"](()=>{n=o,s(0,n)})}return setInterval(c,15),[n,v,ie]}class Me extends ee{constructor(e){super(),Z(this,e,ke,Ie,F,{})}}function Ce(t){let e,s,n;return s=new Me({}),{c(){e=K("main"),_e(s.$$.fragment)},m(i,r){U(i,e,r),Q(s,e,null),n=!0},p:b,i(i){n||(J(s.$$.fragment,i),n=!0)},o(i){ve(s.$$.fragment,i),n=!1},d(i){i&&j(e),V(s)}}}class Le extends ee{constructor(e){super(),Z(this,e,null,Ce,F,{})}}new Le({target:document.body});
