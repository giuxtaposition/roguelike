var ie=Object.defineProperty;var re=(t,e,s)=>e in t?ie(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var a=(t,e,s)=>(re(t,typeof e!="symbol"?e+"":e,s),s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))n(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const l of r.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&n(l)}).observe(document,{childList:!0,subtree:!0});function s(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerpolicy&&(r.referrerPolicy=i.referrerpolicy),i.crossorigin==="use-credentials"?r.credentials="include":i.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(i){if(i.ep)return;i.ep=!0;const r=s(i);fetch(i.href,r)}})();function v(){}function D(t){return t()}function R(){return Object.create(null)}function M(t){t.forEach(D)}function W(t){return typeof t=="function"}function F(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function le(t){return Object.keys(t).length===0}function G(t,e,s){t.insertBefore(e,s||null)}function H(t){t.parentNode&&t.parentNode.removeChild(t)}function U(t){return document.createElement(t)}function ae(t,e,s,n){return t.addEventListener(e,s,n),()=>t.removeEventListener(e,s,n)}function oe(t){return function(e){return e.preventDefault(),t.call(this,e)}}function ue(t,e,s){s==null?t.removeAttribute(e):t.getAttribute(e)!==s&&t.setAttribute(e,s)}function ce(t){return Array.from(t.childNodes)}let S;function $(t){S=t}function he(){if(!S)throw new Error("Function called outside component initialization");return S}function fe(t){he().$$.on_mount.push(t)}const x=[],B=[],I=[],X=[],de=Promise.resolve();let L=!1;function ge(){L||(L=!0,de.then(K))}function O(t){I.push(t)}const k=new Set;let b=0;function K(){if(b!==0)return;const t=S;do{try{for(;b<x.length;){const e=x[b];b++,$(e),me(e.$$)}}catch(e){throw x.length=0,b=0,e}for($(null),x.length=0,b=0;B.length;)B.pop()();for(let e=0;e<I.length;e+=1){const s=I[e];k.has(s)||(k.add(s),s())}I.length=0}while(x.length);for(;X.length;)X.pop()();L=!1,k.clear(),$(t)}function me(t){if(t.fragment!==null){t.update(),M(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(O)}}const C=new Set;let pe;function q(t,e){t&&t.i&&(C.delete(t),t.i(e))}function ye(t,e,s,n){if(t&&t.o){if(C.has(t))return;C.add(t),pe.c.push(()=>{C.delete(t),n&&(s&&t.d(1),n())}),t.o(e)}else n&&n()}function Te(t){t&&t.c()}function J(t,e,s,n){const{fragment:i,after_update:r}=t.$$;i&&i.m(e,s),n||O(()=>{const l=t.$$.on_mount.map(D).filter(W);t.$$.on_destroy?t.$$.on_destroy.push(...l):M(l),t.$$.on_mount=[]}),r.forEach(O)}function Q(t,e){const s=t.$$;s.fragment!==null&&(M(s.on_destroy),s.fragment&&s.fragment.d(e),s.on_destroy=s.fragment=null,s.ctx=[])}function _e(t,e){t.$$.dirty[0]===-1&&(x.push(t),ge(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function V(t,e,s,n,i,r,l,T=[-1]){const f=S;$(t);const c=t.$$={fragment:null,ctx:[],props:r,update:v,not_equal:i,bound:R(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(f?f.$$.context:[])),callbacks:R(),dirty:T,skip_bound:!1,root:e.target||f.$$.root};l&&l(c.root);let w=!1;if(c.ctx=s?s(t,e.props||{},(d,_,...E)=>{const A=E.length?E[0]:_;return c.ctx&&i(c.ctx[d],c.ctx[d]=A)&&(!c.skip_bound&&c.bound[d]&&c.bound[d](A),w&&_e(t,d)),_}):[],c.update(),w=!0,M(c.before_update),c.fragment=n?n(c.ctx):!1,e.target){if(e.hydrate){const d=ce(e.target);c.fragment&&c.fragment.l(d),d.forEach(H)}else c.fragment&&c.fragment.c();e.intro&&q(t.$$.fragment),J(t,e.target,e.anchor,e.customElement),K()}$(f)}class Z{$destroy(){Q(this,1),this.$destroy=v}$on(e,s){if(!W(s))return v;const n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(s),()=>{const i=n.indexOf(s);i!==-1&&n.splice(i,1)}}$set(e){this.$$set&&!le(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}function Y(t,e){for(let s=1e3;s>0;s--)if(e())return;throw"Timeout while trying to "+t}function j(t,e){return Math.floor(Math.random()*(e-t+1))+t}function ee(t){let e,s;for(let n=1;n<t.length;n++)s=j(0,n),e=t[n],t[n]=t[s],t[s]=e;return t}class te{constructor(e,s,n,i,r){a(this,"x");a(this,"y");a(this,"sprite");a(this,"isPassable");a(this,"entity");a(this,"map");this.x=e,this.y=s,this.sprite=n,this.isPassable=i,this.map=r}distance(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}replace(e){this.map.getTiles()[this.x][this.y]=new e(this.x,this.y,this.map)}getEntity(){return this.entity}setEntity(e){this.entity=e}getCoordinates(){return{x:this.x,y:this.y}}getIsPassable(){return this.isPassable}getSprite(){return this.sprite}}class se extends te{constructor(e,s,n){super(e,s,2,!0,n)}}class z extends te{constructor(e,s,n){super(e,s,3,!1,n)}}var P;let u=(P=class{constructor(){a(this,"tiles",[]);Y("generate map",()=>this.generateTiles()==this.getConnectedTiles(this.getRandomPassableTile()).length)}getAdjacentPassableTiles(e){return this.getAdjacentTiles(e).filter(s=>s.getIsPassable())}getRandomPassableTile(){let e;return Y("get random passable tile",()=>{let s=j(0,u.numTiles-1),n=j(0,u.numTiles-1);return e=this.getTile(s,n),e.getIsPassable()}),e}getTile(e,s){return u.inBounds(e,s)?this.tiles[e][s]:new z(e,s,this)}getAdjacentTiles(e){const{x:s,y:n}=e.getCoordinates();return ee([this.getTile(s,n-1),this.getTile(s,n+1),this.getTile(s-1,n),this.getTile(s+1,n)])}getTiles(){return this.tiles}static inBounds(e,s){return e>0&&s>0&&e<u.numTiles-1&&s<u.numTiles-1}generateTiles(){let e=0;for(let s=0;s<u.numTiles;s++){this.tiles[s]=[];for(let n=0;n<u.numTiles;n++)Math.random()<.3||!u.inBounds(s,n)?this.tiles[s][n]=new z(s,n,this):(this.tiles[s][n]=new se(s,n,this),e++)}return e}getConnectedTiles(e){let s=[e],n=[e];for(;n.length;){let i=n.pop(),r=this.getAdjacentPassableTiles(i).filter(l=>!s.includes(l));s=s.concat(r),n=n.concat(r)}return s}},a(P,"tileSize",64),a(P,"numTiles",9),a(P,"uiWidth",4),P);const N=class{constructor(e,s,n){a(this,"tile");a(this,"sprite");a(this,"health");a(this,"isPlayer",!1);a(this,"isAlive",!0);a(this,"hasAttackedThisTurn",!1);a(this,"isStunned",!1);this.move(e),this.sprite=s,this.health=n}update(e,s,n){if(this.isStunned){this.isStunned=!1;return}this.doEntityBehavior(e,s,n)}tryToMove(e){if(e.getIsPassable())return e.getEntity()?e.getEntity().getIsPlayer()!==this.isPlayer&&(this.hasAttackedThisTurn=!0,e.getEntity().isStunned=!0,e.getEntity().receiveDamage(1)):this.move(e),!0}receiveDamage(e){this.health-=e,this.health<=0&&this.die()}getIsStunned(){return this.isStunned}getTile(){return this.tile}getIsAlive(){return this.isAlive}getIsPlayer(){return this.isPlayer}getHealth(){return this.health}getSprite(){return this.sprite}move(e){this.tile&&this.tile.setEntity(null),this.tile=e,e.setEntity(this)}doEntityBehavior(e,s,n){const i=e.filter(r=>r.getIsPassable()&&(!r.getEntity()||r.getEntity().getIsPlayer()));if(i.length){i.sort((c,w)=>c.distance(s.tile)-w.distance(s.tile));const{x:r,y:l}=i[0].getCoordinates(),{x:T,y:f}=this.tile.getCoordinates();this.tryToMove(n(this,r-T,l-f))}}receiveHealth(e){this.health=Math.min(N.maxHealth,this.health+e)}die(){this.isAlive=!1,this.tile.setEntity(null),this.sprite=1}};let y=N;a(y,"maxHealth",6);class ve extends y{constructor(e){super(e,4,3)}}class we extends y{constructor(e){super(e,5,1)}doEntityBehavior(e,s,n){this.hasAttackedThisTurn=!1,super.doEntityBehavior(e,s,n),this.hasAttackedThisTurn||super.doEntityBehavior(e,s,n)}}class be extends y{constructor(e){super(e,6,2)}doEntityBehavior(e,s,n){let i=e.filter(r=>r.getIsPassable()&&(!r.getEntity()||r.getEntity().getIsPlayer()));if(i.length){const{x:r,y:l}=i[0].getCoordinates(),{x:T,y:f}=this.tile.getCoordinates();this.tryToMove(n(this,r-T,l-f))}}}class xe extends y{constructor(e){super(e,7,1)}doEntityBehavior(e,s,n){const i=e.filter(r=>!r.getIsPassable()&&u.inBounds(r.getCoordinates().x,r.getCoordinates().y));i.length?(i[0].replace(se),this.receiveHealth(.5)):super.doEntityBehavior(e,s,n)}}class Ee extends y{constructor(e){super(e,8,3)}update(e,s,n){let i=this.isStunned;super.update(e,s,n),i||(this.isStunned=!0)}}class Pe extends y{constructor(e){super(e,0,3),this.isPlayer=!0}}class $e{constructor(){a(this,"level",1);a(this,"map");a(this,"enemies",[]);a(this,"player");this.generateLevel(),this.player=new Pe(this.map.getRandomPassableTile())}movePlayer(e){let s=!1;switch(e){case p.UP:s=this.player.tryToMove(this.getTileAtDistanceXY(this.player,0,-1));break;case p.DOWN:s=this.player.tryToMove(this.getTileAtDistanceXY(this.player,0,1));break;case p.LEFT:s=this.player.tryToMove(this.getTileAtDistanceXY(this.player,-1,0));break;case p.RIGHT:s=this.player.tryToMove(this.getTileAtDistanceXY(this.player,1,0));break}s&&this.tick()}tick(){for(let e=this.enemies.length-1;e>=0;e--){const s=this.enemies[e];s.getIsAlive()?s.update(this.map.getAdjacentTiles(s.getTile()),this.player,this.getTileAtDistanceXY.bind(this)):this.removeEnemy(e)}}removeEnemy(e){this.enemies.splice(e,1)}getTileAtDistanceXY(e,s,n){const{x:i,y:r}=e.getTile().getCoordinates();return this.map.getTile(i+s,r+n)}generateLevel(){this.map=new u,this.generateEnemies()}generateEnemies(){let e=this.level+1;for(let s=0;s<e;s++)this.spawnEnemies()}spawnEnemies(){let e=ee([ve,we,be,xe,Ee])[0];this.enemies.push(new e(this.map.getRandomPassableTile()))}}var p=(t=>(t[t.UP=0]="UP",t[t.DOWN=1]="DOWN",t[t.LEFT=2]="LEFT",t[t.RIGHT=3]="RIGHT",t))(p||{});function Se(t){let e,s,n;return{c(){e=U("canvas"),ue(e,"class","svelte-3f2pl5")},m(i,r){G(i,e,r),t[2](e),s||(n=ae(window,"keydown",oe(t[1])),s=!0)},p:v,i:v,o:v,d(i){i&&H(e),t[2](null),s=!1,n()}}}function Ae(t,e,s){let n,i;const r=new Image;r.src="spritesheet.png";const l=new $e;function T(o){o.key=="w"&&l.movePlayer(p.UP),o.key=="s"&&l.movePlayer(p.DOWN),o.key=="a"&&l.movePlayer(p.LEFT),o.key=="d"&&l.movePlayer(p.RIGHT)}function f(){i.clearRect(0,0,n.width,n.height),d(),w(),c()}function c(){for(let o=0;o<l.enemies.length;o++){const h=l.enemies[o],{x:g,y:m}=h.getTile().getCoordinates();_(h.getSprite(),g,m),E(h,g,m)}}function w(){const{x:o,y:h}=l.player.getTile().getCoordinates();_(l.player.getSprite(),o,h),E(l.player,o,h)}function d(){for(let o=0;o<u.numTiles;o++)for(let h=0;h<u.numTiles;h++){const g=l.map.getTile(o,h),{x:m,y:ne}=g.getCoordinates();_(g.getSprite(),m,ne)}}function _(o,h,g){i.drawImage(r,o*16,0,16,16,h*u.tileSize,g*u.tileSize,u.tileSize,u.tileSize)}function E(o,h,g){for(let m=0;m<o.getHealth();m++)_(9,h+m%3*(4/16),g-Math.floor(m/3)*(5/16))}fe(()=>{i=n.getContext("2d"),s(0,n.width=u.tileSize*(u.numTiles+u.uiWidth),n),s(0,n.height=u.tileSize*u.numTiles,n),s(0,n.style.width=n.width+"px",n),s(0,n.style.height=n.height+"px",n),i.imageSmoothingEnabled=!1});function A(o){B[o?"unshift":"push"](()=>{n=o,s(0,n)})}return setInterval(f,15),[n,T,A]}class Ie extends Z{constructor(e){super(),V(this,e,Ae,Se,F,{})}}function Ce(t){let e,s,n;return s=new Ie({}),{c(){e=U("main"),Te(s.$$.fragment)},m(i,r){G(i,e,r),J(s,e,null),n=!0},p:v,i(i){n||(q(s.$$.fragment,i),n=!0)},o(i){ye(s.$$.fragment,i),n=!1},d(i){i&&H(e),Q(s)}}}class Me extends Z{constructor(e){super(),V(this,e,null,Ce,F,{})}}new Me({target:document.body});
