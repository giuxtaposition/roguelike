var ve=Object.defineProperty;var we=(s,e,t)=>e in s?ve(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t;var a=(s,e,t)=>(we(s,typeof e!="symbol"?e+"":e,t),t);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const h of r.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&i(h)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerpolicy&&(r.referrerPolicy=n.referrerpolicy),n.crossorigin==="use-credentials"?r.credentials="include":n.crossorigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();function g(){}function se(s){return s()}function K(){return Object.create(null)}function H(s){s.forEach(se)}function ie(s){return typeof s=="function"}function G(s,e){return s!=s?e==e:s!==e||s&&typeof s=="object"||typeof s=="function"}function be(s){return Object.keys(s).length===0}function ne(s,...e){if(s==null)return g;const t=s.subscribe(...e);return t.unsubscribe?()=>t.unsubscribe():t}function re(s){let e;return ne(s,t=>e=t)(),e}function Se(s,e,t){s.$$.on_destroy.push(ne(e,t))}function le(s,e,t){s.insertBefore(e,t||null)}function F(s){s.parentNode&&s.parentNode.removeChild(s)}function ae(s){return document.createElement(s)}function xe(s,e,t,i){return s.addEventListener(e,t,i),()=>s.removeEventListener(e,t,i)}function Pe(s){return function(e){return e.preventDefault(),s.call(this,e)}}function oe(s,e,t){t==null?s.removeAttribute(e):s.getAttribute(e)!==t&&s.setAttribute(e,t)}function Ae(s){return Array.from(s.childNodes)}let O;function C(s){O=s}function Ee(){if(!O)throw new Error("Function called outside component initialization");return O}function $e(s){Ee().$$.on_mount.push(s)}const E=[],j=[],N=[],J=[],Ce=Promise.resolve();let I=!1;function Oe(){I||(I=!0,Ce.then(ue))}function B(s){N.push(s)}const Y=new Set;let P=0;function ue(){if(P!==0)return;const s=O;do{try{for(;P<E.length;){const e=E[P];P++,C(e),Le(e.$$)}}catch(e){throw E.length=0,P=0,e}for(C(null),E.length=0,P=0;j.length;)j.pop()();for(let e=0;e<N.length;e+=1){const t=N[e];Y.has(t)||(Y.add(t),t())}N.length=0}while(E.length);for(;J.length;)J.pop()();I=!1,Y.clear(),C(s)}function Le(s){if(s.fragment!==null){s.update(),H(s.before_update);const e=s.dirty;s.dirty=[-1],s.fragment&&s.fragment.p(s.ctx,e),s.after_update.forEach(B)}}const k=new Set;let Me;function ce(s,e){s&&s.i&&(k.delete(s),s.i(e))}function Re(s,e,t,i){if(s&&s.o){if(k.has(s))return;k.add(s),Me.c.push(()=>{k.delete(s),i&&(t&&s.d(1),i())}),s.o(e)}else i&&i()}function Ne(s){s&&s.c()}function he(s,e,t,i){const{fragment:n,after_update:r}=s.$$;n&&n.m(e,t),i||B(()=>{const h=s.$$.on_mount.map(se).filter(ie);s.$$.on_destroy?s.$$.on_destroy.push(...h):H(h),s.$$.on_mount=[]}),r.forEach(B)}function fe(s,e){const t=s.$$;t.fragment!==null&&(H(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function ke(s,e){s.$$.dirty[0]===-1&&(E.push(s),Oe(),s.$$.dirty.fill(0)),s.$$.dirty[e/31|0]|=1<<e%31}function _e(s,e,t,i,n,r,h,u=[-1]){const p=O;C(s);const o=s.$$={fragment:null,ctx:[],props:r,update:g,not_equal:n,bound:K(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(p?p.$$.context:[])),callbacks:K(),dirty:u,skip_bound:!1,root:e.target||p.$$.root};h&&h(o.root);let x=!1;if(o.ctx=t?t(s,e.props||{},(y,M,...R)=>{const T=R.length?R[0]:M;return o.ctx&&n(o.ctx[y],o.ctx[y]=T)&&(!o.skip_bound&&o.bound[y]&&o.bound[y](T),x&&ke(s,y)),M}):[],o.update(),x=!0,H(o.before_update),o.fragment=i?i(o.ctx):!1,e.target){if(e.hydrate){const y=Ae(e.target);o.fragment&&o.fragment.l(y),y.forEach(F)}else o.fragment&&o.fragment.c();e.intro&&ce(s.$$.fragment),he(s,e.target,e.anchor,e.customElement),ue()}C(p)}class de{$destroy(){fe(this,1),this.$destroy=g}$on(e,t){if(!ie(t))return g;const i=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return i.push(t),()=>{const n=i.indexOf(t);n!==-1&&i.splice(n,1)}}$set(e){this.$$set&&!be(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}function Q(s,e){for(let t=1e3;t>0;t--)if(e())return;throw"Timeout while trying to "+s}function z(s,e){return Math.floor(Math.random()*(e-s+1))+s}function W(s){let e,t;for(let i=1;i<s.length;i++)t=z(0,i),e=s[i],s[i]=s[t],s[t]=e;return s}class U{constructor(e,t,i,n,r){a(this,"_x");a(this,"_y");a(this,"_sprite");a(this,"_effect");a(this,"_effectCounter");a(this,"_entity");a(this,"_map");a(this,"_hasTreasure",!1);a(this,"_isPassable");this._x=e,this._y=t,this._sprite=i,this._isPassable=n,this._map=r}distance(e){return Math.abs(this._x-e._x)+Math.abs(this._y-e._y)}replace(e){this._map.tiles[this._x][this._y]=new e(this._x,this._y,this._map)}get effect(){return this._effect}set effect(e){this._effect=e,this._effectCounter=30}get effectCounter(){return this._effectCounter}set effectCounter(e){this._effectCounter=e}get hasTreasure(){return this._hasTreasure}set hasTreasure(e){this._hasTreasure=e}get entity(){return this._entity}set entity(e){this._entity=e}get coordinates(){return{x:this._x,y:this._y}}get isPassable(){return this._isPassable}get sprite(){return this._sprite}}class pe extends U{constructor(e,t,i){super(e,t,2,!0,i)}}class V extends U{constructor(e,t,i){super(e,t,3,!1,i)}}class Z extends U{constructor(e,t,i){super(e,t,11,!0,i)}}var $;let _=($=class{constructor(){a(this,"_tiles",[]);Q("generate map",()=>this.generateTiles()==this.getConnectedTiles(this.getRandomPassableTile()).length)}getTileAtDistanceXY(e,t,i){const{x:n,y:r}=e.coordinates;return this.getTile(n+t,r+i)}getAdjacentPassableTiles(e){return this.getAdjacentTiles(e).filter(t=>t.isPassable)}getRandomPassableTile(){let e;return Q("get random passable tile",()=>{let t=z(0,_.numTiles-1),i=z(0,_.numTiles-1);return e=this.getTile(t,i),e.isPassable}),e}getTile(e,t){return _.inBounds(e,t)?this._tiles[e][t]:new V(e,t,this)}getAdjacentTiles(e){const{x:t,y:i}=e.coordinates;return W([this.getTile(t,i-1),this.getTile(t,i+1),this.getTile(t-1,i),this.getTile(t+1,i)])}get tiles(){return this._tiles}static inBounds(e,t){return e>0&&t>0&&e<_.numTiles-1&&t<_.numTiles-1}generateTiles(){let e=0;for(let t=0;t<_.numTiles;t++){this._tiles[t]=[];for(let i=0;i<_.numTiles;i++)Math.random()<.3||!_.inBounds(t,i)?this._tiles[t][i]=new V(t,i,this):(this._tiles[t][i]=new pe(t,i,this),e++)}return e}getConnectedTiles(e){let t=[e],i=[e];for(;i.length;){let n=i.pop(),r=this.getAdjacentPassableTiles(n).filter(h=>!t.includes(h));t=t.concat(r),i=i.concat(r)}return t}},a($,"tileSize",64),a($,"numTiles",12),a($,"uiWidth",4),$);const A=[];function me(s,e=g){let t;const i=new Set;function n(u){if(G(s,u)&&(s=u,t)){const p=!A.length;for(const o of i)o[1](),A.push(o,s);if(p){for(let o=0;o<A.length;o+=2)A[o][0](A[o+1]);A.length=0}}}function r(u){n(u(s))}function h(u,p=g){const o=[u,p];return i.add(o),i.size===1&&(t=e(n)||g),u(s),()=>{i.delete(o),i.size===0&&(t(),t=null)}}return{set:n,update:r,subscribe:h}}const He=me({hit1:new Audio("sounds/hit1.wav"),hit2:new Audio("sounds/hit2.mp3"),treasure:new Audio("sounds/treasure.wav"),newLevel:new Audio("sounds/newLevel.wav"),spell:new Audio("sounds/spell.wav")});function L(s){const e=re(He)[s];e.currentTime=0,e.play()}const D=class{constructor(e,t,i){a(this,"_isPlayer",!1);a(this,"_isAlive",!0);a(this,"_hasAttackedThisTurn",!1);a(this,"_isStunned",!1);a(this,"_teleportCounter",2);a(this,"_offsetX",0);a(this,"_offsetY",0);a(this,"_tile");a(this,"_sprite");a(this,"_health");this.move(e),this._sprite=t,this._health=i}update(e,t,i){if(this._teleportCounter--,!(this._teleportCounter>0)){if(this._isStunned){this._isStunned=!1;return}this.doEntityBehavior(e,t,i)}}tryToMove(e){if(e.isPassable){if(!e.entity)this.move(e);else if(e.entity.isPlayer!==this._isPlayer){this._hasAttackedThisTurn=!0,e.entity._isStunned=!0,e.entity.receiveDamage(1);const{x:t,y:i}=this._tile.coordinates,{x:n,y:r}=e.coordinates;this.bumpAnimation(n,t,r,i)}return!0}}receiveDamage(e){this._health-=e,this._health<=0&&this.die(),this._isPlayer?L("hit1"):L("hit2")}receiveHealth(e){this._health=Math.min(D.maxHealth,this._health+e)}smoothMoveAnimation(){this._offsetX-=Math.sign(this._offsetX)*(1/8),this._offsetY-=Math.sign(this._offsetY)*(1/8)}get offsetX(){return this._offsetX}get offsetY(){return this._offsetY}get displayCoordinates(){const{x:e,y:t}=this._tile.coordinates;return{x:e+this._offsetX,y:t+this._offsetY}}get teleportCounter(){return this._teleportCounter}get isStunned(){return this._isStunned}get tile(){return this._tile}get isAlive(){return this._isAlive}get isPlayer(){return this._isPlayer}get health(){return this._health}get sprite(){return this._sprite}bumpAnimation(e,t,i,n){this._offsetX=(e-t)/2,this._offsetY=(i-n)/2}move(e){if(this._tile){this._tile.entity=null;const{x:t,y:i}=this._tile.coordinates,{x:n,y:r}=e.coordinates;this._offsetX=t-n,this._offsetY=i-r}this._tile=e,e.entity=this}doEntityBehavior(e,t,i){const n=e.filter(r=>r.isPassable&&(!r.entity||r.entity.isPlayer));if(n.length){n.sort((o,x)=>o.distance(t._tile)-x.distance(t._tile));const{x:r,y:h}=n[0].coordinates,{x:u,y:p}=this._tile.coordinates;this.tryToMove(i(this._tile,r-u,h-p))}}die(){this._isAlive=!1,this._tile.entity=null,this._sprite=1}};let w=D;a(w,"maxHealth",6);class Xe extends w{constructor(e){super(e,4,3)}}class Ye extends w{constructor(e){super(e,5,1)}doEntityBehavior(e,t,i){this._hasAttackedThisTurn=!1,super.doEntityBehavior(e,t,i),this._hasAttackedThisTurn||super.doEntityBehavior(e,t,i)}}class je extends w{constructor(e){super(e,6,2)}doEntityBehavior(e,t,i){let n=e.filter(r=>r.isPassable&&(!r.entity||r.entity.isPlayer));if(n.length){const{x:r,y:h}=n[0].coordinates,{x:u,y:p}=this._tile.coordinates;this.tryToMove(i(this._tile,r-u,h-p))}}}class Ie extends w{constructor(e){super(e,7,1)}doEntityBehavior(e,t,i){const n=e.filter(r=>!r.isPassable&&_.inBounds(r.coordinates.x,r.coordinates.y));n.length?(n[0].replace(pe),this.receiveHealth(.5)):super.doEntityBehavior(e,t,i)}}class Be extends w{constructor(e){super(e,8,3)}update(e,t,i){let n=this._isStunned;super.update(e,t,i),n||(this._isStunned=!0)}}var ge=(s=>(s.HEALING_AURA="Healing Aura",s))(ge||{});class ze{constructor(){a(this,"_spellName")}castSpell(e,t){}get spellName(){return this._spellName}}class Ge{static newSpell(e){switch(e){case"Healing Aura":return new Fe}}}class Fe extends ze{constructor(){super(...arguments);a(this,"_spellName","Healing Aura")}castSpell(t,i){t.getAdjacentTiles(i.tile).forEach(n=>{n.effect=13,n.entity&&n.entity.receiveHealth(1)}),i.tile.effect=13,i.receiveHealth(1)}}class We extends w{constructor(t,i){super(t,0,i);a(this,"_isPlayer",!0);a(this,"_spells",[]);a(this,"numSpells",1);const n=W(Object.values(ge)).splice(0,this.numSpells);this.addSpells(n)}castSpell(t,i,n){this._spells[t]&&(this._spells[t].castSpell(i,n),delete this._spells[t],L("spell"))}get spells(){return this._spells}get spellNames(){return this._spells.map(t=>t.spellName)}addSpells(t){t.forEach(i=>{this._spells.push(Ge.newSpell(i))})}}class Ue{constructor(e){a(this,"_startingHealth",3);a(this,"_maxHealth",10);a(this,"_maxLevel",6);a(this,"_gameState",m.Loading);a(this,"_score",0);a(this,"_enemies",[]);a(this,"_level");a(this,"_map");a(this,"_player");a(this,"_spawnRate");a(this,"_spawnCounter");a(this,"_scoreStore");this._scoreStore=e}start(){this._level=1,this.startLevel(this._startingHealth),this._gameState=m.Running}movePlayer(e){let t=!1;switch(e){case v.UP:t=this.tryToMovePlayer(0,-1);break;case v.DOWN:t=this.tryToMovePlayer(0,1);break;case v.LEFT:t=this.tryToMovePlayer(-1,0);break;case v.RIGHT:t=this.tryToMovePlayer(1,0);break}t&&this.tick()}castSpell(e){this._player.castSpell(e,this._map,this._player)}startLevel(e){this._enemies=[],this._spawnRate=15,this._spawnCounter=this._spawnRate,this.generateLevel(),this._player=new We(this._map.getRandomPassableTile(),e),this._map.getRandomPassableTile().replace(Z)}get score(){return this._score}get gameState(){return this._gameState}set gameState(e){this._gameState=e}get player(){return this._player}get map(){return this._map}get enemies(){return this._enemies}get maxHealth(){return this._maxHealth}get level(){return this._level}set level(e){this._level=e}get maxLevel(){return this._maxLevel}addScore(e){let t=this._scoreStore.get(),i={score:this._score,run:1,totalScore:this._score,active:e},n=t.pop();n&&(n.active?(i.run=n.run+1,i.totalScore+=n.totalScore):t.push(n)),t.push(i),this._scoreStore.set(t)}tick(){for(let e=this._enemies.length-1;e>=0;e--){const t=this._enemies[e];t.isAlive?t.update(this._map.getAdjacentTiles(t.tile),this._player,this._map.getTileAtDistanceXY.bind(this._map)):this.removeEnemy(e)}this._player.isAlive||(this.addScore(!1),this._gameState=m.GameOver),this._spawnCounter--,this._spawnCounter<=0&&(this.spawnEnemies(),this._spawnCounter=this._spawnRate,this._spawnRate--)}tryToMovePlayer(e,t){const i=this._map.getTileAtDistanceXY(this._player.tile,e,t);return i instanceof Z&&!i.entity&&this.playerSteppedOnExitTile(),i.hasTreasure&&this.playerSteppedOnTreasure(i),this._player.tryToMove(i)}playerSteppedOnExitTile(){L("newLevel"),this._level==this._maxLevel?(this.addScore(!0),this._gameState=m.GameOver):(this._level+=1,this.startLevel(Math.min(this._maxHealth,this._player.health+1)))}playerSteppedOnTreasure(e){L("treasure"),this._score+=1,e.hasTreasure=!1,this.spawnEnemies()}removeEnemy(e){this._enemies.splice(e,1)}generateLevel(){this._map=new _,this.generateEnemies(),this.generateTreasures()}generateTreasures(){for(let e=0;e<3;e++)this._map.getRandomPassableTile().hasTreasure=!0}generateEnemies(){let e=this._level+1;for(let t=0;t<e;t++)this.spawnEnemies()}spawnEnemies(){let e=W([Xe,Ye,je,Ie,Be])[0];this._enemies.push(new e(this._map.getRandomPassableTile()))}}var v=(s=>(s[s.UP=0]="UP",s[s.DOWN=1]="DOWN",s[s.LEFT=2]="LEFT",s[s.RIGHT=3]="RIGHT",s))(v||{}),m=(s=>(s.Title="title",s.GameOver="gameOver",s.Running="running",s.Loading="loading",s))(m||{});const De=(s,e)=>{const t=h=>JSON.stringify(h,null,2),i=JSON.parse;localStorage.getItem(s)===null&&localStorage.setItem(s,t(e));const n=i(localStorage.getItem(s)),r=me(n);return{subscribe:r.subscribe,set:h=>(localStorage.setItem(s,t(h)),r.set(h)),update:r.update,get:()=>re(r)}},ee=De("scores",[]);function qe(s){let e,t,i;return{c(){e=ae("canvas"),oe(e,"class","svelte-7suhn9")},m(n,r){le(n,e,r),s[2](e),t||(i=xe(window,"keydown",Pe(s[1])),t=!0)},p:g,i:g,o:g,d(n){n&&F(e),s[2](null),t=!1,i()}}}function te(s){let e="";return s.forEach(t=>{t+="";for(let i=t.length;i<10;i++)t+=" ";e+=t}),e}function Ke(s,e,t){let i;Se(s,ee,l=>t(6,i=l));let n,r;const h=new Image;h.src="spritesheet.png",h.onload=o;const u=new Ue(ee);function p(l){switch(u.gameState){case m.Title:u.start();break;case m.GameOver:o();break;case m.Running:l.key=="w"&&u.movePlayer(v.UP),l.key=="s"&&u.movePlayer(v.DOWN),l.key=="a"&&u.movePlayer(v.LEFT),l.key=="d"&&u.movePlayer(v.RIGHT),parseInt(l.key)>=1&&parseInt(l.key)<=9&&u.castSpell(parseInt(l.key)-1);break}}function o(){r.fillStyle="rgba(0,0,0,.75)",r.fillRect(0,0,n.width,n.height),u.gameState=m.Title,b("a simple",40,!0,n.height/2-110,"white"),b("ROGUELIKE",70,!0,n.height/2-50,"white"),ye()}function x(){(u.gameState===m.Running||u.gameState===m.GameOver)&&(r.clearRect(0,0,n.width,n.height),R(),M(),y(),b("Level: "+u.level,30,!1,40,"#bd516d"),b("Score: "+u.score,30,!1,70,"#bd516d"))}function y(){for(let l=0;l<u.enemies.length;l++){const d=u.enemies[l],{x:c,y:f}=d.displayCoordinates;d.teleportCounter>0?T(10,c,f):(T(d.sprite,c,f),q(d,c,f)),d.smoothMoveAnimation()}}function M(){const l=u.player,{x:d,y:c}=l.displayCoordinates;T(l.sprite,d,c),q(l,d,c),l.smoothMoveAnimation();for(let f=0;f<l.spellNames.length;f++){let S=f+1+") "+(l.spellNames[f]||"");b(S,20,!1,110+f*40,"#81c0c6")}}function R(){for(let l=0;l<_.numTiles;l++)for(let d=0;d<_.numTiles;d++){const c=u.map.getTile(l,d),{x:f,y:S}=c.coordinates;T(c.sprite,f,S),c.hasTreasure&&T(12,f,S),c.effectCounter&&(c.effectCounter-=1,r.globalAlpha=c.effectCounter/30,T(c.effect,f,S),r.globalAlpha=1)}}function T(l,d,c){r.drawImage(h,l*16,0,16,16,d*_.tileSize,c*_.tileSize,_.tileSize,_.tileSize)}function q(l,d,c){for(let f=0;f<l.health;f++)T(9,d+f%3*(4/16),c-Math.floor(f/3)*(5/16))}function ye(){let l=i;if(l.length){b(te(["RUN","SCORE","TOTAL"]),18,!0,n.height/2,"white");let d=l.pop();l.sort((c,f)=>f.totalScore-c.totalScore),l.unshift(d);for(let c=0;c<Math.min(10,l.length);c++){let f=te([l[c].run.toString(),l[c].score.toString(),l[c].totalScore.toString()]);b(f,18,!0,n.height/2+24+c*24,c===0?"#81c0c6":"#e5858c")}}}function b(l,d,c,f,S){r.fillStyle=S,r.font=d+"px monospace";let X;c?X=(n.width-r.measureText(l).width)/2:X=_.tileSize*_.numTiles+25,r.fillText(l,X,f)}$e(()=>{r=n.getContext("2d"),t(0,n.width=_.tileSize*(_.numTiles+_.uiWidth),n),t(0,n.height=_.tileSize*_.numTiles,n),t(0,n.style.width=n.width+"px",n),t(0,n.style.height=n.height+"px",n),r.imageSmoothingEnabled=!1});function Te(l){j[l?"unshift":"push"](()=>{n=l,t(0,n)})}return setInterval(x,15),[n,p,Te]}class Je extends de{constructor(e){super(),_e(this,e,Ke,qe,G,{})}}function Qe(s){let e,t,i;return t=new Je({}),{c(){e=ae("main"),Ne(t.$$.fragment),oe(e,"class","svelte-cuxfl6")},m(n,r){le(n,e,r),he(t,e,null),i=!0},p:g,i(n){i||(ce(t.$$.fragment,n),i=!0)},o(n){Re(t.$$.fragment,n),i=!1},d(n){n&&F(e),fe(t)}}}class Ve extends de{constructor(e){super(),_e(this,e,null,Qe,G,{})}}new Ve({target:document.body});
